@{
    Layout = "_LayoutMesero";
    ViewData["Title"] = "Detalles de Orden";
}

<div class="overlay">
    <div class="modal">
        <header class="modal-header warm">
            <h1 id="tituloOrden">üìã Detalles de Orden</h1>
            <button class="close" onclick="window.location.href='/Mesero/panelMesero'">‚úï</button>
        </header>

        <div class="modal-body warm-body">
            <div id="cargando" class="loading warm-loading">Cargando detalles...</div>

            <div id="contenidoPedido" style="display:none;">
                <div class="info-principal warm-info">
                    <div class="columna">
                        <p><strong>ü™ë Mesa</strong><br><span id="numMesa"></span></p>
                        <p><strong>üë®‚Äçüç≥ Mesero</strong><br><span id="nombreMesero"></span></p>
                    </div>

                    <div class="columna">
                        <p><strong>üïí Hora</strong><br><span id="fechaHora"></span></p>
                        <p><strong>Estado</strong><br><span class="estado" id="estadoPedido"></span></p>
                    </div>

                    <div class="notas warm-notas">
                        <label for="notas">Notas</label><br>
                        <textarea id="notas" rows="4" readonly></textarea>
                    </div>
                </div>

                <h3 class="warm-subtitle">Productos</h3>
                <div id="listaProductos"></div>

                <div class="total-container warm-total">
                    <span>Total:</span>
                    <strong id="totalPedido">$0.00</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            pedidoId: obtenerIdDeUrl(),
            pedido: null
        };

        const ui = {
            cargando: document.getElementById('cargando'),
            contenedor: document.getElementById('contenidoPedido'),
            titulo: document.getElementById('tituloOrden'),
            mesa: document.getElementById('numMesa'),
            mesero: document.getElementById('nombreMesero'),
            fechaHora: document.getElementById('fechaHora'),
            estado: document.getElementById('estadoPedido'),
            notas: document.getElementById('notas'),
            total: document.getElementById('totalPedido'),
            productos: document.getElementById('listaProductos')
        };

        init();

        function init() {
            if (!state.pedidoId) {
                mostrarError('ID de pedido no v√°lido.');
                return;
            }
            cargarDetallesPedido();
        }

        function getAuthToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const response = await fetch(url, { ...options, headers });
            const isJson = (response.headers.get('content-type') || '').includes('application/json');
            const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');
            if (!response.ok) {
                const message = Array.isArray(body)
                    ? body.join(', ')
                    : (body?.message || (typeof body === 'string' && body.trim()) || `Error ${response.status}`);
                throw new Error(message);
            }
            return body;
        }

        async function cargarDetallesPedido() {
            mostrarCargando(true);
            try {
                const data = await fetchWithAuth(`/api/Pedidos/VerDetalles/${state.pedidoId}`);
                state.pedido = normalizarPedido(data);
                renderPedido();
            } catch (error) {
                console.error('Error al obtener pedido:', error);
                mostrarError(error?.message || 'No se pudieron cargar los detalles del pedido.');
            } finally {
                mostrarCargando(false);
            }
        }

        function normalizarPedido(data = {}) {
            const detalles = (data.detalles ?? data.Detalles ?? []).map(detalle => ({
                nombre: detalle.nombreProducto ?? detalle.NombreProducto ?? 'Producto sin nombre',
                cantidad: Number(detalle.cantidad ?? detalle.Cantidad ?? 0),
                precioUnitario: Number(detalle.precioUnitario ?? detalle.PrecioUnitario ?? 0),
                subtotal: Number(detalle.subtotal ?? detalle.Subtotal ?? 0)
            }));

            return {
                id: data.id ?? data.Id ?? state.pedidoId,
                numMesa: data.numMesa ?? data.NumMesa ?? '‚Äî',
                mesero: data.usuarioNombre ?? data.UsuarioNombre ?? '‚Äî',
                tomadoEn: data.tomadoEn ?? data.TomadoEn ?? null,
                estado: data.estado ?? data.Estado ?? '‚Äî',
                notas: data.notasEspeciales ?? data.NotasEspeciales ?? '',
                precioTotal: Number(data.precioTotal ?? data.PrecioTotal ?? 0),
                detalles
            };
        }

        function renderPedido() {
            if (!state.pedido) return;

            ui.titulo.textContent = `Detalles de Orden #${state.pedido.id}`;
            ui.mesa.textContent = state.pedido.numMesa || '‚Äî';
            ui.mesero.textContent = state.pedido.mesero || '‚Äî';
            ui.fechaHora.textContent = state.pedido.tomadoEn ? formatearFecha(state.pedido.tomadoEn) : '‚Äî';
            ui.estado.textContent = state.pedido.estado || '‚Äî';
            ui.notas.value = state.pedido.notas || 'Sin notas especiales';
            ui.total.textContent = `$${state.pedido.precioTotal.toFixed(2)}`;

            renderProductos(state.pedido.detalles);
            ui.contenedor.style.display = 'block';
        }

        function renderProductos(detalles = []) {
            ui.productos.innerHTML = '';

            if (!detalles.length) {
                ui.productos.innerHTML = '<p class="warm-empty">Esta orden no contiene productos.</p>';
                return;
            }

            const fragment = document.createDocumentFragment();
            detalles.forEach(detalle => {
                fragment.appendChild(crearProductoElemento(detalle));
            });
            ui.productos.appendChild(fragment);
        }

        function crearProductoElemento(detalle) {
            const producto = document.createElement('div');
            producto.className = 'producto warm-producto';

            const info = document.createElement('div');
            info.className = 'detalles';
            info.innerHTML = `
                <p class="nombre">${escapeHtml(detalle.nombre)}</p>
                <p class="cantidad">Cantidad: ${detalle.cantidad}</p>
            `;

            const precio = document.createElement('div');
            precio.className = 'precio';
            precio.innerHTML = `
                <p class="total">$${detalle.subtotal.toFixed(2)}</p>
                <p class="unitario">Unitario: $${detalle.precioUnitario.toFixed(2)}</p>
            `;

            producto.appendChild(info);
            producto.appendChild(precio);
            return producto;
        }

        function mostrarCargando(mostrar) {
            if (ui.cargando) ui.cargando.style.display = mostrar ? 'block' : 'none';
            if (ui.contenedor && mostrar) ui.contenedor.style.display = 'none';
        }

        function mostrarError(mensaje) {
            if (ui.cargando) {
                ui.cargando.textContent = mensaje;
                ui.cargando.classList.add('error');
                ui.cargando.style.display = 'block';
            } else {
                alert(mensaje);
            }
        }

        function obtenerIdDeUrl() {
            const partes = window.location.pathname.split('/').filter(Boolean);
            const idx = partes.indexOf('detalleordenDato');
            if (idx === -1 || idx === partes.length - 1) return null;
            const id = Number(partes[idx + 1]);
            return Number.isFinite(id) ? id : null;
        }

        function formatearFecha(valor) {
            const fecha = new Date(valor);
            if (Number.isNaN(fecha.getTime())) return '‚Äî';
            return fecha.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(str = '') {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
    });
</script>
