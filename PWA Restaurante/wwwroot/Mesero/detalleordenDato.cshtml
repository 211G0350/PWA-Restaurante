@{
    Layout = "_LayoutMesero";
    ViewData["Title"] = "Detalles de Orden";
}

<div class="overlay">
    <div class="modal">
        <header class="modal-header warm">
            <h1 id="tituloOrden">üìã Detalles de Orden</h1>
            <button class="close" onclick="window.location.href='/Mesero/panelMesero'">‚úï</button>
        </header>

        <div class="modal-body warm-body">
            <div id="cargando" class="loading warm-loading">Cargando detalles...</div>

            <div id="contenidoPedido" style="display:none;">
                <div class="info-principal warm-info">
                    <div class="columna">
                        <p><strong>ü™ë Mesa</strong><br><span id="numMesa"></span></p>
                        <p><strong>üë®‚Äçüç≥ Mesero</strong><br><span id="nombreMesero"></span></p>
                    </div>

                    <div class="columna">
                        <p><strong>üïí Hora</strong><br><span id="fechaHora"></span></p>
                        <p><strong>Estado</strong><br><span class="estado" id="estadoPedido"></span></p>
                    </div>

                    <div class="notas warm-notas">
                        <label for="notas">Notas</label><br>
                        <textarea id="notas" rows="4" readonly></textarea>
                    </div>
                </div>

                <h3 class="warm-subtitle">Productos</h3>
                <div id="listaProductos"></div>

                <div class="total-container warm-total">
                    <span>Total:</span>
                    <strong id="totalPedido">$0.00</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    function obtenerIdDeUrl() {
        const path = window.location.pathname.split('/');
        const idx = path.indexOf('detalleordenDato') + 1;
        return idx < path.length ? parseInt(path[idx]) : null;
    }

    function formatearFecha(fecha) {
        const d = new Date(fecha);
        return d.toLocaleString('es-ES', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }

    async function cargarDetallesPedido() {
        const pedidoId = obtenerIdDeUrl();
        if (!pedidoId) return alert('ID de pedido no v√°lido');

        const cargando = document.getElementById('cargando');
        const cont = document.getElementById('contenidoPedido');
        cargando.style.display = 'block';
        cont.style.display = 'none';

        try {
            const token = getAuthToken();
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const resp = await fetch(`/api/Pedidos/VerDetalles/${pedidoId}`, { headers });
            if (!resp.ok) throw new Error('Error al cargar');

            const pedido = await resp.json();

            document.getElementById('tituloOrden').textContent = `Detalles de Orden #${pedido.Id || pedido.id}`;
            document.getElementById('numMesa').textContent = pedido.NumMesa || '';
            document.getElementById('nombreMesero').textContent = pedido.UsuarioNombre || '';
            document.getElementById('fechaHora').textContent = formatearFecha(pedido.TomadoEn || '');
            document.getElementById('estadoPedido').textContent = pedido.Estado || '';
            document.getElementById('notas').value = pedido.NotasEspeciales || '';
            document.getElementById('totalPedido').textContent = `$${(pedido.PrecioTotal || 0).toFixed(2)}`;

            const lista = document.getElementById('listaProductos');
            lista.innerHTML = '';

            if (pedido.Detalles?.length > 0) {
                pedido.Detalles.forEach(d => {
                    lista.innerHTML += `
                        <div class="producto warm-producto">
                            <div class="detalles">
                                <p class="nombre">${d.NombreProducto}</p>
                                <p class="cantidad">Cantidad: ${d.Cantidad}</p>
                            </div>
                            <div class="precio">
                                <p class="total">$${d.Subtotal.toFixed(2)}</p>
                                <p class="unitario">Unitario: $${d.PrecioUnitario.toFixed(2)}</p>
                            </div>
                        </div>`;
                });
            } else {
                lista.innerHTML = '<p>No hay productos en este pedido</p>';
            }

            cargando.style.display = 'none';
            cont.style.display = 'block';
        } catch (err) {
            console.error(err);
            alert('Error al cargar los detalles');
        }
    }

    document.addEventListener('DOMContentLoaded', cargarDetallesPedido);
</script>
