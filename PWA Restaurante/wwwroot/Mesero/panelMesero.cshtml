@{
    Layout = "_LayoutMesero";
    ViewData["Title"] = "Panel Mesero";
}

<button class="new-order-btn" id="btnCrearOrden"><i class="fa-solid fa-plus"></i> CREAR NUEVA ORDEN</button>

<section class="orders-section">
    <h3><i class="fa-regular fa-clock"></i> Órdenes Pendientes</h3>
    <div id="pedidosPendientes">
    </div>
</section>

<section class="orders-section">
    <h3><i class="fa-regular fa-clipboard"></i> Órdenes Activas (<span id="contadorActivas">0</span>)</h3>
    <div id="pedidosActivos">
    </div>
</section>





<script>
    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    function formatearFecha(fecha) {
        const date = new Date(fecha);
        return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }

    function obtenerEstadoTexto(estado) {
        const estados = {
            'pendiente': 'Sin Enviar',
            'enviado': 'Enviado',
            'en preparacion': 'En Preparación',
            'listo': 'Listo'
        };
        return estados[estado.toLowerCase()] || estado;
    }

    function obtenerClaseEstado(estado) {
        const clases = {
            'pendiente': 'pending',
            'enviado': 'sent',
            'en preparacion': 'preparing',
            'listo': 'ready'
        };
        return clases[estado.toLowerCase()] || 'pending';
    }

    async function cargarPedidosPendientes() {
        try {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/Pedidos/Pendientes', { headers });
            if (!response.ok) {
                throw new Error('Error al cargar pedidos pendientes');
            }

            const pedidos = await response.json();
            const container = document.getElementById('pedidosPendientes');
            container.innerHTML = '';

            if (pedidos.length === 0) {
                container.innerHTML = '<p>No hay pedidos pendientes</p>';
                return;
            }

            pedidos.forEach(pedido => {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <div class="order-header">
                        <h4>Mesa ${pedido.NumMesa || pedido.numMesa}</h4>
                        <span class="status pending">${obtenerEstadoTexto(pedido.Estado || pedido.estado)}</span>
                    </div>
                    <div class="order-body">
                        <p class="time">${formatearFecha(pedido.TomadoEn || pedido.tomadoEn)}</p>
                        <p class="price">$${(pedido.PrecioTotal || pedido.precioTotal).toFixed(2)}</p>
                    </div>
                    <button class="details-btn" onclick="verDetalles(${pedido.Id || pedido.id})"><i class="fa-regular fa-eye"></i> Ver Detalles</button>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error al cargar pedidos pendientes:', error);
            document.getElementById('pedidosPendientes').innerHTML = '<p>Error al cargar los pedidos pendientes</p>';
        }
    }

    async function cargarPedidosActivos() {
        try {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/Pedidos/Todos', { headers });
            if (!response.ok) {
                throw new Error('Error al cargar pedidos activos');
            }

            const pedidos = await response.json();
            const container = document.getElementById('pedidosActivos');
            container.innerHTML = '';
            document.getElementById('contadorActivas').textContent = pedidos.length;

            if (pedidos.length === 0) {
                container.innerHTML = '<p>No hay pedidos activos</p>';
                return;
            }

            pedidos.forEach(pedido => {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.innerHTML = `
                    <div class="order-header">
                        <h4>Mesa ${pedido.NumMesa || pedido.numMesa}</h4>
                        <span class="status sent">${obtenerEstadoTexto(pedido.Estado || pedido.estado)}</span>
                    </div>
                    <div class="order-body">
                        <p class="time">${formatearFecha(pedido.TomadoEn || pedido.tomadoEn)}</p>
                        <p class="price">$${(pedido.PrecioTotal || pedido.precioTotal).toFixed(2)}</p>
                    </div>
                    <button class="details-btn" onclick="verDetalles(${pedido.Id || pedido.id})"><i class="fa-regular fa-eye"></i> Ver Detalles</button>
                `;
                container.appendChild(card);
            });
        } catch (error) {
            console.error('Error al cargar pedidos activos:', error);
            document.getElementById('pedidosActivos').innerHTML = '<p>Error al cargar los pedidos activos</p>';
        }
    }

    function verDetalles(pedidoId) {
        window.location.href = `/Mesero/detalleordenDato/${pedidoId}`;
    }

    document.getElementById('btnCrearOrden').addEventListener('click', function() {
        window.location.href = '/Mesero/crearNuevaOr';
    });

    document.addEventListener('DOMContentLoaded', () => {
        cargarPedidosPendientes();
        cargarPedidosActivos();
    });
</script>
