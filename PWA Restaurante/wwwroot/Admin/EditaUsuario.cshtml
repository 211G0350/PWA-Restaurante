@{
    ViewData["Title"] = "Editar Usuario - Panel Admin";
    Layout = "_LayoutAdmin";
}

<body>
  <div class="modal">
    <div class="modal-content">
      <h2>Editar Datos Usuario</h2>
      
      <div id="mensajeError" style="display: none; color: red; margin-bottom: 10px;"></div>
      <div id="cargando" style="display: none; text-align: center; margin: 20px 0;">Cargando datos del usuario...</div>
      
      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" required>

      <label for="rol">Rol:</label>
      <select id="rol" required>
        <option value="">Selecciona un rol</option>
        <option value="Mesero">Mesero</option>
        <option value="Cocinero">Cocinero</option>
        <option value="Admin">Admin</option>
      </select>

      <label for="correo">Correo:</label>
      <input type="email" id="correo" required>

      <label for="contraseña">Contraseña:</label>
      <input type="password" id="contraseña" placeholder="Dejar vacío para mantener la contraseña actual">

      <div class="modal-buttons">
        <button class="btn-editar" id="btnEditar">Editar</button>
        <button class="btn-cancelar" id="btnCancelar">Cancelar</button>
      </div>
    </div>
  </div>

<script>
    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    function obtenerIdDeUrl() {
        const path = window.location.pathname;
        const parts = path.split('/');
        const idIndex = parts.indexOf('EditaUsuario') + 1;
        return idIndex < parts.length ? parseInt(parts[idIndex]) : null;
    }

    let userId = null;

    async function cargarUsuario() {
        userId = obtenerIdDeUrl();
        if (!userId) {
            alert('ID de usuario no válido');
            window.location.href = '/Admin/usuariosadmin';
            return;
        }

        try {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`/api/Usuarios/ObtenerPorId/${userId}`, { headers });
            if (!response.ok) {
                if (response.status === 404) {
                    alert('Usuario no encontrado');
                    window.location.href = '/Admin/usuariosadmin';
                    return;
                }
                throw new Error('Error al cargar usuario');
            }

            const usuario = await response.json();

            document.getElementById('nombre').value = usuario.Nombre || usuario.nombre || '';
            document.getElementById('correo').value = usuario.Correo || usuario.correo || '';
            document.getElementById('rol').value = usuario.Rol || usuario.rol || '';
        } catch (error) {
            console.error('Error al cargar usuario:', error);
            alert('Error al cargar el usuario');
            window.location.href = '/Admin/usuariosadmin';
        } finally {
            document.getElementById('cargando').style.display = 'none';
        }
    }

    function cancelar() {
        window.location.href = '/Admin/usuariosadmin';
    }

    document.getElementById('btnEditar').addEventListener('click', async function() {
        if (!userId) {
            alert('Error: ID de usuario no válido');
            return;
        }

        const nombre = document.getElementById('nombre').value.trim();
        const rol = document.getElementById('rol').value;
        const correo = document.getElementById('correo').value.trim();
        const contrasena = document.getElementById('contraseña').value.trim();

        if (!nombre || !rol || !correo) {
            document.getElementById('mensajeError').textContent = 'Por favor, completa todos los campos obligatorios.';
            document.getElementById('mensajeError').style.display = 'block';
            return;
        }

        try {
            const token = getAuthToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const datos = {
                Nombre: nombre,
                Rol: rol,
                Correo: correo
            };
            if (contrasena) {
                datos.Contrasena = contrasena;
            }

            const response = await fetch(`/api/Usuarios/Editar/${userId}`, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(datos)
            });

            const result = await response.json();

            if (response.ok) {
                alert(result.message || 'Usuario actualizado exitosamente');
                window.location.href = '/Admin/usuariosadmin';
            } else {
                const errorMsg = Array.isArray(result) ? result.join(', ') : (result.message || 'Error al actualizar usuario');
                document.getElementById('mensajeError').textContent = errorMsg;
                document.getElementById('mensajeError').style.display = 'block';
            }
        } catch (error) {
            console.error('Error al editar usuario:', error);
            alert('Error al actualizar el usuario');
        }
    });

    document.getElementById('btnCancelar').addEventListener('click', cancelar);

    document.addEventListener('DOMContentLoaded', cargarUsuario);
</script>

</body>
