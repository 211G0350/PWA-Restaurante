@{
    ViewData["Title"] = "Editar Producto - Panel Admin";
    Layout = "_LayoutAdmin";
}
<body>
    <main>
        <h2 class="titulo-principal">Editar Producto</h2>

        <div class="form-container">
            <form id="formEditarProducto">
                <input type="hidden" id="productoId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label>Precio:</label>
                        <input type="number" step="0.01" min="0" id="precio" required>
                    </div>

                    <div class="form-group">
                        <label>Categoría:</label>
                        <input type="text" id="categoria" list="categoriasList" placeholder="Seleccione o escriba una categoría" required>
                        <datalist id="categoriasList">
                        </datalist>
                    </div>

                    <div class="form-group">
                        <label>Tiempo Preparación (mins):</label>
                        <input type="number" min="1" id="tiempo" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripción:</label>
                    <textarea id="descripcion"></textarea>
                </div>

                <div class="form-group">
                    <label>Foto Producto:</label>
                    <div class="upload-container">
                        <img id="imagenPreview" src="" alt="Producto" onerror="this.src='/Img/default.jpg'">
                        <input type="file" id="imagen" accept="image/jpeg,.jpg" style="display: none;">
                        <button type="button" class="upload-btn" onclick="document.getElementById('imagen').click()">Upload a File</button>
                    </div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn btn-editar">Editar</button>
                    <button type="button" class="btn btn-cancelar" onclick="cancelar()">Cancelar</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        function getAuthToken() {
          return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        function obtenerIdDeUrl() {
          const path = window.location.pathname;
          const parts = path.split('/');
          const idIndex = parts.indexOf('EditProducto') + 1;
          return idIndex < parts.length ? parseInt(parts[idIndex]) : null;
        }

        async function cargarProducto() {
          const id = obtenerIdDeUrl();
          if (!id) {
            alert('ID de producto no válido');
            window.location.href = '/Admin/adminProducts';
            return;
          }

          try {
            const token = getAuthToken();
            const headers = {
              'Content-Type': 'application/json'
            };
            if (token) {
              headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`/api/Productos/ObtenerPorId/${id}`, { headers });
            if (!response.ok) {
              if (response.status === 404) {
                alert('Producto no encontrado');
                window.location.href = '/Admin/adminProducts';
                return;
              }
              throw new Error('Error al cargar producto');
            }

            const producto = await response.json();

            document.getElementById('productoId').value = producto.id;
            document.getElementById('nombre').value = producto.nombre;
            document.getElementById('precio').value = producto.precio;
            document.getElementById('categoria').value = producto.categoria;
            document.getElementById('tiempo').value = producto.tiempoPreparacion;
            document.getElementById('descripcion').value = producto.descripcion || '';
            document.getElementById('imagenPreview').src = `/Img/${producto.id}.jpg`;
          } catch (error) {
            console.error('Error al cargar producto:', error);
            alert('Error al cargar el producto');
            window.location.href = '/Admin/adminProducts';
          }
        }

        async function cargarCategorias() {
          try {
            const token = getAuthToken();
            const headers = {
              'Content-Type': 'application/json'
            };
            if (token) {
              headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/Productos/Categorias', { headers });
            if (!response.ok) throw new Error('Error al cargar categorías');

            const categorias = await response.json();
            const datalist = document.getElementById('categoriasList');
            datalist.innerHTML = '';
            categorias.forEach(categoria => {
              const option = document.createElement('option');
              option.value = categoria;
              datalist.appendChild(option);
            });
          } catch (error) {
            console.error('Error al cargar categorías:', error);
          }
        }

        document.getElementById('imagen').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              document.getElementById('imagenPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

        function cancelar() {
          window.location.href = '/Admin/adminProducts';
        }

        document.getElementById('formEditarProducto').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = document.getElementById('productoId').value;
          const formData = new FormData();
          formData.append('Id', id);
          formData.append('Nombre', document.getElementById('nombre').value);
          formData.append('Categoria', document.getElementById('categoria').value);
          formData.append('Descripcion', document.getElementById('descripcion').value || '');
          formData.append('Precio', document.getElementById('precio').value);
          formData.append('TiempoPreparacion', document.getElementById('tiempo').value);
          formData.append('Activo', 'true');

          const archivo = document.getElementById('imagen').files[0];
          if (archivo) {
            formData.append('img', archivo);
          }

          try {
            const token = getAuthToken();
            const headers = {};
            if (token) {
              headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/Productos/Editar', {
              method: 'PUT',
              headers: headers,
              body: formData
            });

            const result = await response.json();

            if (response.ok) {
              alert(result.message || 'Producto actualizado exitosamente');
              window.location.href = '/Admin/adminProducts';
            } else {
              const errorMsg = Array.isArray(result) ? result.join(', ') : (result.message || 'Error al actualizar producto');
              alert(errorMsg);
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error al actualizar producto. Por favor, intente nuevamente.');
          }
        });

        document.addEventListener('DOMContentLoaded', () => {
          cargarCategorias();
          cargarProducto();
        });
    </script>

</body>

