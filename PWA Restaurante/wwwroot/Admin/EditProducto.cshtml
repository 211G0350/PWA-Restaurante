@{
    ViewData["Title"] = "Editar Producto - Panel Admin";
    Layout = "_LayoutAdmin";
}
<body>
    <main>
        <h2 class="titulo-principal">Editar Producto</h2>

        <div class="form-container">
            <form id="formEditarProducto">
                <input type="hidden" id="productoId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label>Precio:</label>
                        <input type="number" step="0.01" min="0" id="precio" required>
                    </div>

                    <div class="form-group">
                        <label>Categoría:</label>
                        <input type="text" id="categoria" list="categoriasList" placeholder="Seleccione o escriba una categoría" required>
                        <datalist id="categoriasList">
                        </datalist>
                    </div>

                    <div class="form-group">
                        <label>Tiempo Preparación (mins):</label>
                        <input type="number" min="1" id="tiempo" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripción:</label>
                    <textarea id="descripcion"></textarea>
                </div>

                <div class="form-group">
                    <label>Foto Producto:</label>
                    <div class="upload-container">
                        <img id="imagenPreview" src="" alt="Producto" onerror="this.src='/Img/default.jpg'">
                        <input type="file" id="imagen" accept="image/jpeg,.jpg" style="display: none;">
                        <button type="button" class="upload-btn" onclick="document.getElementById('imagen').click()">Upload a File</button>
                        <div class="form-group" style="margin-left: 15px; margin-top: 0;">
                            <label>Activo:</label>
                            <select id="activo" required>
                                <option value="true">Activo</option>
                                <option value="false">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn btn-editar">Editar</button>
                    <button type="button" class="btn btn-cancelar" onclick="cancelar()">Cancelar</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        function getAuthToken() {
          return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        async function fetchWithAuth(url, options = {}) {
          const token = getAuthToken();
          const headers = {
            'Content-Type': 'application/json',
            ...options.headers
          };

          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }

          const response = await fetch(url, {
            ...options,
            headers
          });

          const contentType = response.headers.get('content-type') || '';
          const isJson = contentType.includes('application/json');
          const body = isJson
            ? await response.json().catch(() => null)
            : await response.text().catch(() => '');

          if (!response.ok) {
            let message = `Error ${response.status}`;

            if (Array.isArray(body)) {
              message = body.join(' ');
            } else if (body && typeof body === 'object' && 'message' in body) {
              message = body.message;
            } else if (typeof body === 'string' && body.trim().length > 0) {
              message = body;
            }

            throw new Error(message);
          }

          return body;
        }

        function obtenerIdDeUrl() {
          const path = window.location.pathname;
          const parts = path.split('/');
          const idIndex = parts.indexOf('EditProducto') + 1;
          return idIndex < parts.length ? parseInt(parts[idIndex]) : null;
        }

        async function cargarProducto() {
          const id = obtenerIdDeUrl();
          if (!id) {
            alert('ID de producto no válido');
            window.location.href = '/Admin/adminProducts';
            return null;
          }

          try {
            const producto = await fetchWithAuth(`/api/Productos/ObtenerPorId/${id}`);

            document.getElementById('productoId').value = producto.id;
            document.getElementById('nombre').value = producto.nombre;
            document.getElementById('precio').value = producto.precio;
            document.getElementById('categoria').value = producto.categoria;
            document.getElementById('tiempo').value = producto.tiempoPreparacion;
            document.getElementById('descripcion').value = producto.descripcion || '';
            document.getElementById('activo').value = producto.activo ? 'true' : 'false';
            document.getElementById('imagenPreview').src = `/Img/${producto.id}.jpg?v=${Date.now()}`;

            return producto;
          } catch (error) {
            console.error('Error al cargar producto:', error);
            alert(error.message || 'Error al cargar el producto');
            window.location.href = '/Admin/adminProducts';
            return null;
          }
        }

        async function cargarCategorias(categoriaActual) {
          try {
            const categorias = await fetchWithAuth('/api/Productos/Categorias');
            const datalist = document.getElementById('categoriasList');
            datalist.innerHTML = '';

            const opciones = Array.isArray(categorias) ? [...categorias] : [];
            if (categoriaActual && !opciones.includes(categoriaActual)) {
              opciones.push(categoriaActual);
            }

            opciones
              .filter(Boolean)
              .sort((a, b) => a.localeCompare(b))
              .forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                datalist.appendChild(option);
              });
          } catch (error) {
            console.error('Error al cargar categorías:', error);
          }
        }

        document.getElementById('imagen').addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              document.getElementById('imagenPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        });

        function cancelar() {
          window.location.href = '/Admin/adminProducts';
        }

        document.getElementById('formEditarProducto').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = obtenerIdDeUrl();
          if (!id) {
            alert('ID de producto no válido');
            return;
          }

          const formData = new FormData();
          formData.append('Id', id.toString());
          formData.append('Nombre', document.getElementById('nombre').value);
          formData.append('Categoria', document.getElementById('categoria').value);
          formData.append('Descripcion', document.getElementById('descripcion').value || '');
          formData.append('Precio', document.getElementById('precio').value);
          formData.append('TiempoPreparacion', document.getElementById('tiempo').value);
          formData.append('Activo', document.getElementById('activo').value);
          formData.append('ImagenProducto', '');
          console.log('Enviando datos:', {
            id: id,
            nombre: document.getElementById('nombre').value,
            categoria: document.getElementById('categoria').value,
            precio: document.getElementById('precio').value,
            tiempo: document.getElementById('tiempo').value,
            activo: document.getElementById('activo').value
          });

          const archivo = document.getElementById('imagen').files[0];
          if (archivo) {
            formData.append('archivo', archivo);
          }

          try {
            const token = getAuthToken();
            const headers = {};
            if (token) {
              headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`/api/Productos/Editar/${id}`, {
              method: 'PUT',
              headers: headers,
              body: formData
            });

            const contentType = response.headers.get('content-type') || '';
            const isJson = contentType.includes('application/json');
            const result = isJson
              ? await response.json().catch(() => null)
              : await response.text().catch(() => '');

            if (response.ok) {
              const mensaje = result && typeof result === 'object' && 'message' in result
                ? result.message
                : (typeof result === 'string' && result.trim().length > 0 ? result : 'Producto actualizado exitosamente');
              alert(mensaje);
              window.location.href = `/Admin/adminProducts?v=${Date.now()}`;
            } else {
              let errorMsg = 'Error al actualizar producto';
              
              if (Array.isArray(result)) {
                errorMsg = result.join(', ');
              } else if (result && typeof result === 'object') {
                if (Array.isArray(result.errors)) {
                  errorMsg = result.errors.join(', ');
                } else if ('message' in result) {
                  errorMsg = result.message;
                }
              } else if (typeof result === 'string' && result.trim().length > 0) {
                errorMsg = result;
              }
              
              console.error('Error completo:', result);
              alert(errorMsg);
            }
          } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'Error al actualizar producto. Por favor, intente nuevamente.');
          }
        });

        document.addEventListener('DOMContentLoaded', async () => {
          const producto = await cargarProducto();
          const categoriaActual = producto ? (producto.categoria || producto.Categoria) : null;
          await cargarCategorias(categoriaActual);
        });
    </script>

</body>

