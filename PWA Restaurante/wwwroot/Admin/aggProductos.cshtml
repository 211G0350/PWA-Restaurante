@{
    ViewData["Title"] = "Panel Admin - Agregar Producto";
    Layout = "_LayoutAdmin";
}
<body>
    <!--Checar estos estilos funcionen con el nuevo css-->
    <main>
        <h2 class="titulo-principal">Agregar Producto</h2>

        <div class="form-container">
            <form id="formAgregarProducto">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombre">Nombre del Producto:</label>
                        <input type="text" id="nombre" placeholder="Ej. Cappuccino" required>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoría:</label>
                        <input type="text" id="categoria" list="categoriasList" placeholder="Seleccione o escriba una categoría" required>
                        <datalist id="categoriasList">
                        </datalist>
                    </div>
                </div>

                <div class="form-group">
                    <label for="descripcion">Descripción:</label>
                    <textarea id="descripcion" placeholder="Escribe una breve descripción..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="precio">Precio:</label>
                        <input type="number" id="precio" step="0.01" min="0" placeholder="Ej. 2.50" required>
                    </div>
                    <div class="form-group">
                        <label for="tiempo">Tiempo de preparación (min):</label>
                        <input type="number" id="tiempo" min="1" placeholder="Ej. 5" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="imagen">Imagen del Producto:</label>
                    <input type="file" id="imagen" accept="image/jpeg,.jpg">
                </div>

                <div class="btn-container">
                    <button type="button" class="btn btn-cancelar" onclick="cancelar()">Cancelar</button>
                    <button type="submit" class="btn btn-guardar">Guardar Producto</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        function getAuthToken() {
          return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        async function cargarCategorias() {
          try {
            const token = getAuthToken();
            const headers = {
              'Content-Type': 'application/json'
            };
            if (token) {
              headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/Productos/Categorias', { headers });
            if (!response.ok) throw new Error('Error al cargar categorías');

            const categorias = await response.json();
            const datalist = document.getElementById('categoriasList');
            datalist.innerHTML = '';
            categorias.forEach(categoria => {
              const option = document.createElement('option');
              option.value = categoria;
              datalist.appendChild(option);
            });
          } catch (error) {
            console.error('Error al cargar categorías:', error);
          }
        }

        function cancelar() {
          window.location.href = '/Admin/adminProducts';
        }

        document.getElementById('formAgregarProducto').addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData();
          formData.append('Nombre', document.getElementById('nombre').value);
          formData.append('Categoria', document.getElementById('categoria').value);
          formData.append('Descripcion', document.getElementById('descripcion').value || '');
          formData.append('Precio', document.getElementById('precio').value);
          formData.append('TiempoPreparacion', document.getElementById('tiempo').value);
          formData.append('Activo', 'true');

          const archivo = document.getElementById('imagen').files[0];
          if (archivo) {
            formData.append('archivo', archivo);
          }

          try {
            const token = getAuthToken();
            const headers = {};
            if (token) {
              headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch('/api/Productos/AgregarProducto', {
              method: 'POST',
              headers: headers,
              body: formData
            });

            const result = await response.json();

            if (response.ok) {
              alert(result.message || 'Producto agregado exitosamente');
              window.location.href = '/Admin/adminProducts';
            } else {
              const errorMsg = Array.isArray(result) ? result.join(', ') : (result.message || 'Error al agregar producto');
              alert(errorMsg);
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error al agregar producto. Por favor, intente nuevamente.');
          }
        });

        document.addEventListener('DOMContentLoaded', () => {
          cargarCategorias();
        });
    </script>
</body>