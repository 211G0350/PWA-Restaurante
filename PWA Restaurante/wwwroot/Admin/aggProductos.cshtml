@{
    ViewData["Title"] = "Panel Admin - Agregar Producto";
    Layout = "_LayoutAdmin";
}

<main class="agregar-producto-main">
    <h2 class="titulo-principal">Agregar Producto</h2>

    <div class="form-container">
        <form id="formAgregarProducto">
            <div class="form-row">
                <div class="form-group">
                    <label for="nombre">Nombre del Producto:</label>
                    <input type="text" id="nombre" placeholder="Ej. Cappuccino" required>
                </div>
                <div class="form-group">
                    <label for="categoria">Categoría:</label>
                    <input type="text" id="categoria" list="categoriasList" placeholder="Seleccione o escriba una categoría" required>
                    <datalist id="categoriasList"></datalist>
                </div>
            </div>

            <div class="form-group">
                <label for="descripcion">Descripción:</label>
                <textarea id="descripcion" placeholder="Escribe una breve descripción..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="precio">Precio:</label>
                    <input type="number" id="precio" step="0.01" min="0" placeholder="Ej. 2.50" required>
                </div>
                <div class="form-group">
                    <label for="tiempo">Tiempo de preparación (min):</label>
                    <input type="number" id="tiempo" min="1" placeholder="Ej. 5" required>
                </div>
            </div>

            <div class="form-group">
                <label for="imagen">Imagen del Producto:</label>
                <div class="upload-container">
                @*     <img id="imagenPreview" src="/Img/default.jpg" alt="Producto" onerror="this.src='/Img/default.jpg'"> *@
                    <input type="file" id="imagen" accept="image/jpeg,.jpg" style="display: none;">
                    <button type="button" class="upload-btn" onclick="document.getElementById('imagen').click()">Upload a File</button>
                </div>
            </div>

            <div class="btn-container">
                <button type="button" class="btn btn-cancelar" onclick="cancelar()">Cancelar</button>
                <button type="submit" class="btn btn-guardar">Guardar Producto</button>
            </div>
        </form>
    </div>
</main>


    <script>
        function getAuthToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        async function cargarCategorias() {
            try {
                const token = getAuthToken();
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch('/api/Productos/Categorias', { headers });
                if (!response.ok) throw new Error('Error al cargar categorías');

                const categorias = await response.json();
                const datalist = document.getElementById('categoriasList');
                datalist.innerHTML = '';
                categorias.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar categorías:', error);
            }
        }

        function cancelar() {
            window.location.href = '/Admin/adminProducts';
        }

        document.getElementById('imagen').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    document.getElementById('imagenPreview').src = evt.target?.result || '/Img/default.jpg';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('imagenPreview').src = '/Img/default.jpg';
            }
        });

        document.getElementById('formAgregarProducto').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('Nombre', document.getElementById('nombre').value);
            formData.append('Categoria', document.getElementById('categoria').value);
            formData.append('Descripcion', document.getElementById('descripcion').value || '');
            formData.append('Precio', document.getElementById('precio').value);
            formData.append('TiempoPreparacion', document.getElementById('tiempo').value);
            formData.append('Activo', 'true');

            const archivo = document.getElementById('imagen').files[0];
            if (archivo) formData.append('archivo', archivo);

            try {
                const token = getAuthToken();
                const headers = {};
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch('/api/Productos/AgregarProducto', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message || 'Producto agregado exitosamente');
                    window.location.href = '/Admin/adminProducts';
                } else {
                    const errorMsg = Array.isArray(result)
                        ? result.join(', ')
                        : (result.message || 'Error al agregar producto');
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al agregar producto. Por favor, intente nuevamente.');
            }
        });

        document.addEventListener('DOMContentLoaded', cargarCategorias);

        (function inicializarSignalRProductos() {
            if (!window.signalR) {
                console.warn('SignalR no está disponible');
                return;
            }

            const obtenerToken = () => localStorage.getItem('token') || sessionStorage.getItem('token') || '';

            const connection = new signalR.HubConnectionBuilder()
                .withUrl('/pedidosHub', {
                    accessTokenFactory: () => obtenerToken()
                })
                .withAutomaticReconnect()
                .build();

            connection.on('ProductoAgregado', (data) => {
                console.log('Producto agregado desde otra ventana:', data);
                cargarCategorias();
            });

            connection.on('ProductoEditado', (data) => {
                console.log('Producto editado desde otra ventana:', data);
                cargarCategorias();
            });

            connection.on('ProductoEliminado', (data) => {
                console.log('Producto eliminado desde otra ventana:', data);
                cargarCategorias();
            });

            const iniciarConexion = async () => {
                if (connection.state === signalR.HubConnectionState.Connected || 
                    connection.state === signalR.HubConnectionState.Connecting) {
                    return;
                }

                try {
                    await connection.start();
                    await connection.invoke('JoinAdminGroup');
                    console.log('SignalR conectado para productos');
                } catch (error) {
                    console.error('Error al conectar SignalR:', error);
                    setTimeout(iniciarConexion, 3000);
                }
            };

            document.addEventListener('DOMContentLoaded', () => {
                if (obtenerToken()) {
                    iniciarConexion();
                }
            });
        })();
    </script>

