
@{
    ViewData["Title"] = "Panel Admin - Usuarios";
    Layout = "_LayoutAdmin";
}
<body>

<main>
  <div class="form-overlay">
    <div class="form-container">
      <h2>Agregar Datos Nuevo Usuario</h2>
      
      <div id="mensajeError" style="display: none; color: red; margin-bottom: 10px;"></div>
      
      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" placeholder="Ingresa el nombre" required>

      <label for="rol">Rol:</label>
      <select id="rol" required>
        <option value="">Selecciona un rol</option>
        <option value="Mesero">Mesero</option>
        <option value="Cocinero">Cocinero</option>
        <option value="Admin">Admin</option>
      </select>

      <label for="correo">Correo:</label>
      <input type="email" id="correo" placeholder="ejemplo@correo.com" required>

      <label for="contrasena">Contrase침a:</label>
      <input type="password" id="contrasena" placeholder="********" required>

      <div class="btns">
        <button class="agregar" id="btnAgregar">Agregar</button>
        <button class="cancelar" id="btnCancelar">Cancelar</button>
      </div>
    </div>
  </div>
</main>

<script>
    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    async function fetchWithAuth(url, options = {}) {
        const token = getAuthToken();
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(url, {
            ...options,
            headers
        });

        if (!response.ok) {
            if (response.status === 401) {
                alert('Sesi칩n expirada. Por favor, inicia sesi칩n nuevamente.');
                window.location.href = '/';
                return null;
            }
            let errorData;
            try {
                errorData = await response.json();
            } catch {
                const errorText = await response.text();
                throw new Error(errorText || `Error: ${response.status} ${response.statusText}`);
            }
            
            if (Array.isArray(errorData)) {
                throw new Error(errorData.join(', ') || 'Error de validaci칩n');
            } else if (errorData.message) {
                throw new Error(errorData.message);
            } else {
                throw new Error(errorData || `Error: ${response.status} ${response.statusText}`);
            }
        }

        return response.json();
    }

    function mostrarError(mensaje) {
        const errorDiv = document.getElementById('mensajeError');
        errorDiv.textContent = mensaje;
        errorDiv.style.display = 'block';
    }

    function ocultarError() {
        const errorDiv = document.getElementById('mensajeError');
        errorDiv.style.display = 'none';
    }

    document.getElementById('btnAgregar').addEventListener('click', async function() {
        ocultarError();
        
        const nombre = document.getElementById('nombre').value.trim();
        const rol = document.getElementById('rol').value;
        const correo = document.getElementById('correo').value.trim();
        const contrasena = document.getElementById('contrasena').value;

        if (!nombre || !rol || !correo || !contrasena) {
            mostrarError('Por favor, completa todos los campos.');
            return;
        }

        const btnAgregar = this;
        btnAgregar.disabled = true;
        btnAgregar.textContent = 'Agregando...';

        try {
            const data = await fetchWithAuth('/api/Usuarios/Registrar', {
                method: 'POST',
                body: JSON.stringify({
                    Nombre: nombre,
                    Rol: rol,
                    Correo: correo,
                    Contrasena: contrasena
                })
            });

            if (data) {
                alert('Usuario agregado exitosamente');
                window.location.href = '/Admin/usuariosadmin';
            }
        } catch (error) {
            console.error('Error al agregar usuario:', error);
            mostrarError(error.message || 'Error al agregar el usuario. Por favor, intenta nuevamente.');
            btnAgregar.disabled = false;
            btnAgregar.textContent = 'Agregar';
        }
    });

    document.getElementById('btnCancelar').addEventListener('click', function() {
        window.location.href = '/Admin/usuariosadmin';
    });
</script>

</body>

