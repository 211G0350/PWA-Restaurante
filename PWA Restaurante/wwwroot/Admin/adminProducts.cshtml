@{
    ViewData["Title"] = "Panel Admin - Productos";
    Layout = "_LayoutAdmin";
}

<div class="add-product-container">
    <button id="btn-agregar" class="add-product-btn">Agregar Producto <i class="fa-solid fa-plus"></i></button>
</div>

<!-- TABS -->
<div class="tabs">
    <div class="tab active" data-tab="bebidas">Bebidas</div>
    <div class="tab" data-tab="comidas">Comidas</div>
    <div class="tab" data-tab="ensaladas">Ensaladas</div>
</div>

<!-- PRODUCTOS -->
<div class="productos-grid">
</div>

<script>
    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    async function fetchWithAuth(url, options = {}) {
        const token = getAuthToken();
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(url, {
            ...options,
            headers
        });

        if (!response.ok) {
            if (response.status === 401) {
                alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
                window.location.href = '/';
                return null;
            }
            throw new Error(`Error: ${response.status} ${response.statusText}`);
        }

        return response.json();
    }

    async function cargarProductosPorCategoria(categoria) {
        try {
            const productosGrid = document.querySelector('.productos-grid');
            productosGrid.innerHTML = '<p>Cargando productos...</p>';

            let productos;
            try {
                productos = await fetchWithAuth(`/api/Productos/PorCategoriaAdmin/${encodeURIComponent(categoria)}`);
            } catch (error) {
                productos = await fetchWithAuth(`/api/Productos/PorCategoria/${encodeURIComponent(categoria)}`);
            }

            if (!productos) return;

            renderizarProductos(productos);
        } catch (error) {
            console.error(`Error al cargar productos de la categoría ${categoria}:`, error);
            const productosGrid = document.querySelector('.productos-grid');
            productosGrid.innerHTML = '<p>Error al cargar productos</p>';
        }
    }

    function renderizarProductos(productos) {
        const productosGrid = document.querySelector('.productos-grid');

        if (!productos || productos.length === 0) {
            productosGrid.innerHTML = '<p>No hay productos en esta categoría</p>';
            return;
        }

        productosGrid.innerHTML = productos.map(producto => {
            const nombre = producto.Nombre || producto.nombre || 'Sin nombre';
            const descripcion = producto.Descripcion || producto.descripcion || 'Sin descripción';
            const categoria = producto.Categoria || producto.categoria || '';
            const precio = producto.Precio || producto.precio || 0;
            const tiempoPreparacion = producto.TiempoPreparacion || producto.tiempoPreparacion || 0;
            const id = producto.Id || producto.id || 0;

            return `
                <div class="producto-card">
                    <div class="producto-info">
                        <h4>${nombre}</h4>
                        <p>${descripcion}</p>
                        <p>Categoría: ${categoria}</p>
                        <p class="precio">$${precio.toFixed(2)}</p>
                        <p class="tiempo"><i class="fa-regular fa-clock"></i> ${tiempoPreparacion} min</p>
                    </div>
                    <img src="/Img/${id}.jpg" alt="${nombre}" onerror="this.src='/Img/default.jpg'">
                    <div class="acciones">
                        <button onclick="editarProducto(${id})">Editar</button>
                        <button class="eliminar" onclick="eliminarProducto(${id})">Eliminar</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editarProducto(id) {
        window.location.href = `/Admin/EditProducto/${id}`;
    }

    function eliminarProducto(id) {
        window.location.href = `/Admin/eliminarProducto/${id}`;
    }

    // Manejo de tabs
    const tabs = document.querySelectorAll('.tab');
    const addBtn = document.getElementById('btn-agregar');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remover active de todos los tabs
            tabs.forEach(t => t.classList.remove('active'));
            // Agregar active al tab clickeado
            tab.classList.add('active');

            // Efecto visual en el botón agregar
            addBtn.classList.remove('active-btn');
            addBtn.classList.add('highlighted-btn');
            setTimeout(() => addBtn.classList.remove('highlighted-btn'), 300);

            // Cargar productos de la categoría seleccionada
            const categoria = tab.getAttribute('data-tab');
            cargarProductosPorCategoria(categoria);
        });
    });

    addBtn.addEventListener('click', () => {
        addBtn.classList.toggle('active-btn');
        window.location.href = '/Admin/aggProductos';
    });

    // Cargar productos de la categoría activa al iniciar
    document.addEventListener('DOMContentLoaded', () => {
        const tabActivo = document.querySelector('.tab.active');
        if (tabActivo) {
            const categoria = tabActivo.getAttribute('data-tab');
            cargarProductosPorCategoria(categoria);
        }
    });
</script>
