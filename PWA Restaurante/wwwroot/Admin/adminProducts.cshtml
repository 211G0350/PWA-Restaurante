@{
    ViewData["Title"] = "Panel Admin - Productos";
    Layout = "_LayoutAdmin";
}

<div class="add-product-container">
    <button id="btn-agregar" class="add-product-btn">
        Agregar Producto <i class="fa-solid fa-plus"></i>
    </button>
</div>

<!-- TABS -->
<div class="tabs" id="categoriaTabs"></div>

<!-- PRODUCTOS -->
<div class="productos-grid"></div>

<!-- ===== MODAL EDITAR ===== -->
<div id="modalEditar" class="modal-overlay">
    <div class="modal-editar">
        <h2>Editar Producto</h2>
        <form id="formEditar" enctype="multipart/form-data">
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="editNombre" name="Nombre" />
                </div>
                <div class="form-group">
                    <label>Precio:</label>
                    <input type="number" step="0.01" id="editPrecio" name="Precio" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categor√≠a:</label>
                    <select id="editCategoria" name="Categoria">
                        <option>Comidas</option>
                        <option>Bebidas</option>
                        <option>Postres</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tiempo Preparaci√≥n (mins):</label>
                    <input type="number" id="editTiempo" name="Tiempo" />
                </div>
            </div>

            <div class="nueva-categoria">
                <i class="fa fa-plus-circle"></i> Agregar a Nueva Categor√≠a:
                <input type="text" id="editNuevaCategoria" placeholder="Escribe nueva categor√≠a..." />
            </div>

            <div class="form-group descripcion">
                <label>Descripci√≥n:</label>
                <textarea id="editDescripcion" name="Descripcion"></textarea>
            </div>

            <div class="form-group imagen">
                <label>Foto Producto:</label>
                <div class="preview-container">
                    <img id="editPreview" src="/img/default.jpg" alt="Producto">
                </div>
                <input type="file" id="editFoto" name="Foto" accept="image/*">
            </div>

            <div class="form-buttons">
                <button type="submit" class="btn-editar">Editar</button>
                <button type="button" class="btn-cancelar" onclick="cerrarModal('modalEditar')">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== MODAL ELIMINAR ===== -->
<div id="modalEliminar" class="modal-overlay">
    <div class="modal-box">
        <h2>Eliminar Producto</h2>
        <div class="preview-container">
            <img id="deleteImg" src="/Img/default.jpg" alt="Vista previa del producto">
        </div>
        <p>¬øDesea eliminar el siguiente producto?</p>
        <p><strong id="deleteNombre"></strong></p>
        <p id="deleteCategoria"></p>

        <div class="modal-buttons">
            <button class="eliminar"><i class="fa-solid fa-check"></i> Eliminar</button>
            <button class="btn-cancelar" onclick="cerrarModal('modalEliminar')"><i class="fa-solid fa-xmark"></i> Cancelar</button>
        </div>
    </div>
</div>

<script>
    // üî∏ Redirecci√≥n al formulario para agregar producto
    document.addEventListener('DOMContentLoaded', () => {
        const btnAgregar = document.getElementById('btn-agregar');
        if (btnAgregar) {
            btnAgregar.addEventListener('click', () => {
                window.location.href = '/Admin/aggProductos';
            });
        }
    });

    // ===== FUNCIONES GENERALES =====
    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    async function fetchWithAuth(url, options = {}) {
        const token = getAuthToken();
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const response = await fetch(url, { ...options, headers });
        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');
        if (!response.ok) throw new Error(body?.message || `Error ${response.status}`);
        return body;
    }

    function configurarTab(tab, tabsContainer, addBtn) {
        tab.addEventListener('click', () => {
            tabsContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            addBtn.classList.add('highlighted-btn');
            setTimeout(() => addBtn.classList.remove('highlighted-btn'), 300);
            const categoria = tab.getAttribute('data-tab');
            cargarProductosPorCategoria(categoria);
        });
    }

    async function cargarCategorias() {
        const tabsContainer = document.getElementById('categoriaTabs');
        tabsContainer.innerHTML = '<div class="tab loading">Cargando...</div>';
        try {
            const categorias = await fetchWithAuth('/api/Productos/Categorias');
            tabsContainer.innerHTML = '';
            categorias.forEach((categoria, i) => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.dataset.tab = categoria;
                tab.textContent = categoria;
                configurarTab(tab, tabsContainer, document.getElementById('btn-agregar'));
                if (i === 0) tab.classList.add('active');
                tabsContainer.appendChild(tab);
            });
            if (categorias.length) cargarProductosPorCategoria(categorias[0]);
        } catch {
            tabsContainer.innerHTML = '<div class="tab error">Error al cargar categor√≠as</div>';
        }
    }

    async function cargarProductosPorCategoria(categoria) {
        try {
            const productos = await fetchWithAuth(`/api/Productos/PorCategoriaAdmin/${encodeURIComponent(categoria)}`);
            renderizarProductos(productos);
        } catch {
            document.querySelector('.productos-grid').innerHTML = '<p>Error al cargar productos</p>';
        }
    }

    function renderizarProductos(productos) {
        const productosGrid = document.querySelector('.productos-grid');
        const cacheBuster = Date.now();
        if (!productos.length) {
            productosGrid.innerHTML = '<p>No hay productos</p>';
            return;
        }
        productosGrid.innerHTML = productos.map(p => `
            <div class="producto-card">
                <div class="producto-info">
                    <h4>${p.nombre}</h4>
                    <p>${p.descripcion}</p>
                    <p>Categor√≠a: ${p.categoria}</p>
                    <p class="precio">$${p.precio.toFixed(2)}</p>
                    <p class="tiempo"><i class="fa-regular fa-clock"></i> ${p.tiempoPreparacion} min</p>
                </div>
                <img src="/Img/${p.id}.jpg?v=${cacheBuster}" alt="${p.nombre}" onerror="this.src='/Img/default.jpg'">
                <div class="acciones">
                    <button onclick="abrirModalEditar(${p.id}, '${p.nombre}', '${p.descripcion}', '${p.categoria}', ${p.precio}, ${p.tiempoPreparacion}, '/Img/${p.id}.jpg?v=${cacheBuster}')">Editar</button>
                    <button class="eliminar" onclick="abrirModalEliminar('${p.nombre}', '${p.categoria}', ${p.id})">Eliminar</button>
                </div>
            </div>
        `).join('');
    }

    function abrirModalEditar(id, nombre, descripcion, categoria, precio, tiempo, imagen) {
        document.getElementById('editNombre').value = nombre;
        document.getElementById('editDescripcion').value = descripcion;
        document.getElementById('editCategoria').value = categoria;
        document.getElementById('editPrecio').value = precio;
        document.getElementById('editTiempo').value = tiempo;
        document.getElementById('editPreview').src = imagen;
        document.getElementById('modalEditar').style.display = 'flex';
    }

    function abrirModalEliminar(nombre, categoria, id) {
        document.getElementById('deleteNombre').textContent = nombre;
        document.getElementById('deleteCategoria').textContent = `Categor√≠a: ${categoria}`;
        const img = document.getElementById('deleteImg');
        img.src = `/Img/${id}.jpg?v=${Date.now()}`;
        img.onerror = () => img.src = '/Img/default.jpg';
        document.getElementById('modalEliminar').style.display = 'flex';
    }

    function cerrarModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    const editFoto = document.getElementById('editFoto');
    const editPreview = document.getElementById('editPreview');
    if (editFoto) {
        editFoto.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => editPreview.src = ev.target.result;
                reader.readAsDataURL(file);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', cargarCategorias);
</script>
