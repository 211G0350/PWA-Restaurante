@{
    ViewData["Title"] = "Panel Admin - Productos";
    Layout = "_LayoutAdmin";
}

<div class="add-product-container">
    <button id="btn-agregar" class="add-product-btn">Agregar Producto <i class="fa-solid fa-plus"></i></button>
</div>

<!-- TABS -->
<div class="tabs" id="categoriaTabs"></div>

<!-- PRODUCTOS -->
<div class="productos-grid">
</div>

<script>
    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    async function fetchWithAuth(url, options = {}) {
        const token = getAuthToken();
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(url, {
            ...options,
            headers
        });

        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        const responseBody = isJson
            ? await response.json().catch(() => null)
            : await response.text().catch(() => '');

        if (!response.ok) {
            if (response.status === 401) {
                alert('Sesión expirada. Por favor, inicia sesión nuevamente.');
                window.location.href = '/';
                return null;
            }

            let errorMessage = `Error ${response.status}`;

            if (Array.isArray(responseBody)) {
                errorMessage = responseBody.join(' ');
            } else if (responseBody && typeof responseBody === 'object' && 'message' in responseBody) {
                errorMessage = responseBody.message;
            } else if (typeof responseBody === 'string' && responseBody.trim().length > 0) {
                errorMessage = responseBody;
            }

            throw new Error(errorMessage);
        }

        return responseBody;
    }

    function configurarTab(tab, tabsContainer, addBtn) {
        tab.addEventListener('click', () => {
            tabsContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            addBtn.classList.remove('active-btn');
            addBtn.classList.add('highlighted-btn');
            setTimeout(() => addBtn.classList.remove('highlighted-btn'), 300);

            const categoria = tab.getAttribute('data-tab');
            cargarProductosPorCategoria(categoria);
        });
    }

    async function cargarCategorias() {
        const tabsContainer = document.getElementById('categoriaTabs');
        const addBtn = document.getElementById('btn-agregar');

        tabsContainer.innerHTML = '<div class="tab loading">Cargando categorías...</div>';

        try {
            const categorias = await fetchWithAuth('/api/Productos/Categorias');

            if (!categorias || categorias.length === 0) {
                tabsContainer.innerHTML = '<div class="tab empty">No hay categorías disponibles</div>';
                document.querySelector('.productos-grid').innerHTML = '<p>No hay productos disponibles</p>';
                return;
            }

            tabsContainer.innerHTML = '';

            categorias.forEach((categoria, index) => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.dataset.tab = categoria;
                tab.textContent = categoria;

                configurarTab(tab, tabsContainer, addBtn);

                if (index === 0) {
                    tab.classList.add('active');
                }

                tabsContainer.appendChild(tab);
            });

            const primerTab = tabsContainer.querySelector('.tab');
            if (primerTab) {
                cargarProductosPorCategoria(primerTab.getAttribute('data-tab'));
            }
        } catch (error) {
            console.error('Error al cargar categorías:', error);
            tabsContainer.innerHTML = '<div class="tab error">Error al cargar categorías</div>';
            document.querySelector('.productos-grid').innerHTML = '<p>Error al cargar categorías</p>';
        }
    }

    async function cargarProductosPorCategoria(categoria) {
        try {
            const productosGrid = document.querySelector('.productos-grid');
            productosGrid.innerHTML = '<p>Cargando productos...</p>';

            let productos;
            try {
                productos = await fetchWithAuth(`/api/Productos/PorCategoriaAdmin/${encodeURIComponent(categoria)}`);
            } catch (error) {
                productos = await fetchWithAuth(`/api/Productos/PorCategoria/${encodeURIComponent(categoria)}`);
            }

            if (!productos) return;

            renderizarProductos(productos);
        } catch (error) {
            console.error(`Error al cargar productos de la categoría ${categoria}:`, error);
            const productosGrid = document.querySelector('.productos-grid');
            productosGrid.innerHTML = '<p>Error al cargar productos</p>';
        }
    }

    function renderizarProductos(productos) {
        const productosGrid = document.querySelector('.productos-grid');
        const cacheBuster = Date.now();

        if (!productos || productos.length === 0) {
            productosGrid.innerHTML = '<p>No hay productos en esta categoría</p>';
            return;
        }

        productosGrid.innerHTML = productos.map(producto => {
            const nombre = producto.Nombre || producto.nombre || 'Sin nombre';
            const descripcion = producto.Descripcion || producto.descripcion || 'Sin descripción';
            const categoria = producto.Categoria || producto.categoria || '';
            const precio = producto.Precio || producto.precio || 0;
            const tiempoPreparacion = producto.TiempoPreparacion || producto.tiempoPreparacion || 0;
            const id = producto.Id || producto.id || 0;

            return `
                <div class="producto-card">
                    <div class="producto-info">
                        <h4>${nombre}</h4>
                        <p>${descripcion}</p>
                        <p>Categoría: ${categoria}</p>
                        <p class="precio">$${precio.toFixed(2)}</p>
                        <p class="tiempo"><i class="fa-regular fa-clock"></i> ${tiempoPreparacion} min</p>
                    </div>
                    <img src="/Img/${id}.jpg?v=${cacheBuster}" alt="${nombre}" onerror="this.src='/Img/default.jpg'">
                    <div class="acciones">
                        <button onclick="editarProducto(${id})">Editar</button>
                        <button class="eliminar" onclick="eliminarProducto(${id})">Eliminar</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editarProducto(id) {
        window.location.href = `/Admin/EditProducto/${id}`;
    }

    function eliminarProducto(id) {
        window.location.href = `/Admin/eliminarProducto/${id}`;
    }

    const addBtn = document.getElementById('btn-agregar');

    addBtn.addEventListener('click', () => {
        addBtn.classList.toggle('active-btn');
        window.location.href = '/Admin/aggProductos';
    });

    document.addEventListener('DOMContentLoaded', cargarCategorias);
</script>
