@{
    ViewData["Title"] = "Panel Admin - Productos";
    Layout = "_LayoutAdmin";
}

<div class="add-product-container">
    <button id="btn-agregar" class="add-product-btn">
        Agregar Producto <i class="fa-solid fa-plus"></i>
    </button>
</div>

<!-- TABS -->
<div class="tabs" id="categoriaTabs"></div>

<!-- PRODUCTOS -->
<div class="productos-grid"></div>

<!-- ===== MODAL EDITAR ===== -->
<div id="modalEditar" class="modal-overlay">
    <div class="modal-editar">
        <h2>Editar Producto</h2>
        <form id="formEditar" enctype="multipart/form-data">
            <input type="hidden" id="editProductoId" name="Id" />
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre:</label>
                    <input type="text" id="editNombre" name="Nombre" />
                </div>
                <div class="form-group">
                    <label>Precio:</label>
                    <input type="number" step="0.01" id="editPrecio" name="Precio" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categoría:</label>
                    <input type="text" id="editCategoriaInput" list="editCategoriasList" placeholder="Seleccione o escriba una categoría" autocomplete="off" />
                    <input type="hidden" id="editCategoria" name="Categoria" />
                    <small id="editCategoriaActual" class="categoria-actual"></small>
                    <datalist id="editCategoriasList"></datalist>
                </div>
                <div class="form-group">
                    <label>Tiempo Preparación (mins):</label>
                    <input type="number" id="editTiempo" name="Tiempo" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Activo:</label>
                    <select id="editActivo" name="Activo">
                        <option value="true">Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>
            </div>


            <div class="form-group descripcion">
                <label>Descripción:</label>
                <textarea id="editDescripcion" name="Descripcion"></textarea>
            </div>

            <div class="form-group imagen">
                <label>Foto Producto:</label>
                <div class="preview-container">
                    <img id="editPreview" src="/img/default.jpg" alt="Producto">
                </div>
                <input type="file" id="editFoto" name="Foto" accept="image/*">
            </div>

            <div class="form-buttons">
                <button type="submit" class="btn-editar">Editar</button>
                <button type="button" class="btn-cancelar" onclick="cerrarModal('modalEditar')">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== MODAL ELIMINAR ===== -->
<div id="modalEliminar" class="modal-overlay">
    <div class="modal-box">
        <h2>Eliminar Producto</h2>
        <div class="preview-container">
            <img id="deleteImg" src="/Img/default.jpg" alt="Vista previa del producto">
        </div>
        <p>¿Desea eliminar el siguiente producto?</p>
        <p><strong id="deleteNombre"></strong></p>
        <p id="deleteCategoria"></p>

        <div class="modal-buttons">
            <button class="eliminar"><i class="fa-solid fa-check"></i> Eliminar</button>
            <button class="btn-cancelar" onclick="cerrarModal('modalEliminar')"><i class="fa-solid fa-xmark"></i> Cancelar</button>
        </div>
    </div>
</div>

<script>
    const state = {
        categorias: [],
        categoriaActiva: null,
        productoEditId: null,
        productoDeleteId: null,
        categoriaOriginal: ''
    };

    const ui = {
        btnAgregar: document.getElementById('btn-agregar'),
        tabs: document.getElementById('categoriaTabs'),
        grid: document.querySelector('.productos-grid'),
        formEditar: document.getElementById('formEditar'),
        modalEditar: document.getElementById('modalEditar'),
        modalEliminar: document.getElementById('modalEliminar'),
        edit: {
            id: document.getElementById('editProductoId'),
            nombre: document.getElementById('editNombre'),
            descripcion: document.getElementById('editDescripcion'),
            precio: document.getElementById('editPrecio'),
            tiempo: document.getElementById('editTiempo'),
            activo: document.getElementById('editActivo'),
            foto: document.getElementById('editFoto'),
            preview: document.getElementById('editPreview'),
            categoriaInput: document.getElementById('editCategoriaInput'),
            categoriaHidden: document.getElementById('editCategoria'),
            categoriaActualLabel: document.getElementById('editCategoriaActual'),
            nuevaCategoria: document.getElementById('editNuevaCategoria')
        },
        eliminar: {
            btnConfirmar: document.querySelector('#modalEliminar .eliminar'),
            nombre: document.getElementById('deleteNombre'),
            categoria: document.getElementById('deleteCategoria'),
            imagen: document.getElementById('deleteImg')
        }
    };

    document.addEventListener('DOMContentLoaded', init);

    function getAuthToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
    }

    async function fetchWithAuth(url, options = {}) {
        const token = getAuthToken();
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const response = await fetch(url, { ...options, headers });
        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');
        const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');
        if (!response.ok) {
            const message = Array.isArray(body)
                ? body.join(', ')
                : (body?.message || (typeof body === 'string' && body.trim()) || `Error ${response.status}`);
            throw new Error(message);
        }
        return body;
    }

    function escapeHtml(str = '')
    {
        return String(str) .replace(/&/g, '&amp;') .replace(/</g, '&lt;') .replace(/>/g, '&gt;') .replace(/"/g, '&quot;') .replace(/'/g, '&#39;');
    }

    async function init() {
        prepararBotonAgregar();
        prepararPreviewEdicion();
        prepararFormularioEdicion();
        prepararDatalist();
        prepararEliminar();
        await cargarCategorias(true);
    }

    function prepararBotonAgregar() {
        if (!ui.btnAgregar) return;
        ui.btnAgregar.addEventListener('click', () => {
            window.location.href = '/Admin/aggProductos';
        });
    }

    function prepararPreviewEdicion() {
        if (!ui.edit.foto || !ui.edit.preview) return;
        ui.edit.foto.addEventListener('change', (event) => {
            const file = event.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                ui.edit.preview.src = e.target?.result || '/Img/default.jpg';
            };
            reader.readAsDataURL(file);
        });
    }

    function prepararFormularioEdicion() {
        if (!ui.formEditar) return;
        ui.formEditar.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (!state.productoEditId) {
                alert('No se ha seleccionado un producto para editar.');
                return;
            }

            const nombre = ui.edit.nombre?.value?.trim();
            const descripcion = ui.edit.descripcion?.value || '';
            const categoriaTexto = ui.edit.categoriaInput?.value?.trim();
            const categoriaNueva = ui.edit.nuevaCategoria?.value?.trim();
            const categoria = categoriaNueva || categoriaTexto || ui.edit.categoriaHidden?.value?.trim();
            const precio = ui.edit.precio?.value;
            const tiempo = ui.edit.tiempo?.value;
            const activo = ui.edit.activo?.value ?? 'true';

            if (!nombre || !categoria || !precio || !tiempo) {
                alert('Por favor, complete todos los campos obligatorios.');
                return;
            }

            const formData = new FormData();
            formData.append('Id', state.productoEditId.toString());
            formData.append('Nombre', nombre);
            formData.append('Categoria', categoria);
            formData.append('Descripcion', descripcion);
            formData.append('Precio', precio);
            formData.append('TiempoPreparacion', tiempo);
            formData.append('Activo', activo);
            formData.append('ImagenProducto', '');

            const archivo = ui.edit.foto?.files?.[0];
            if (archivo) formData.append('archivo', archivo);

            try {
                const token = getAuthToken();
                const headers = {};
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(`/api/Productos/Editar/${state.productoEditId}`, {
                    method: 'PUT',
                    headers,
                    body: formData
                });

                const contentType = response.headers.get('content-type') || '';
                const isJson = contentType.includes('application/json');
                const result = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');

                if (response.ok) {
                    const mensaje = result && typeof result === 'object' && 'message' in result
                        ? result.message
                        : (typeof result === 'string' && result.trim().length > 0 ? result : 'Producto actualizado exitosamente');
                    alert(mensaje);
                    cerrarModalInterno(ui.modalEditar);
                    await cargarCategorias(true, true);
                } else {
                    let errorMsg = 'Error al actualizar producto';
                    if (Array.isArray(result)) {
                        errorMsg = result.join(', ');
                    } else if (result && typeof result === 'object') {
                        if (Array.isArray(result.errors)) {
                            errorMsg = result.errors.join(', ');
                        } else if ('message' in result) {
                            errorMsg = result.message;
                        }
                    } else if (typeof result === 'string' && result.trim().length > 0) {
                        errorMsg = result;
                    }
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error al actualizar producto:', error);
                alert(error?.message || 'Error al actualizar producto. Por favor, intente nuevamente.');
            }
        });
    }

    function prepararDatalist() {
        if (!ui.edit.categoriaInput) return;

        ui.edit.categoriaInput.addEventListener('focus', async () => {
            await cargarCategorias(true, true);
            poblarDatalist();
            ui.edit.categoriaInput.select();
        });

        ui.edit.categoriaInput.addEventListener('input', () => sincronizarCategoriaOculta());
        ui.edit.categoriaInput.addEventListener('blur', () => sincronizarCategoriaOculta(true));
    }

    function prepararEliminar() {
        if (ui.eliminar.btnConfirmar) {
            ui.eliminar.btnConfirmar.addEventListener('click', eliminarProductoActual);
        }
    }

    async function cargarCategorias(force = false, mantenerSeleccion = false) {
        if (!force && state.categorias.length) return state.categorias;

        const indicador = '<div class="tab loading">Cargando...</div>';
        if (ui.tabs && !state.categorias.length) ui.tabs.innerHTML = indicador;

        try {
            const categorias = await fetchWithAuth('/api/Productos/Categorias');
            state.categorias = Array.isArray(categorias) ? categorias.filter(Boolean) : [];
            renderTabs();

            const anterior = mantenerSeleccion ? state.categoriaActiva : null;
            if (anterior && state.categorias.includes(anterior)) {
                seleccionarTab(anterior);
            } else if (state.categorias.length) {
                seleccionarTab(state.categorias[0]);
            } else {
                state.categoriaActiva = null;
                if (ui.grid) ui.grid.innerHTML = '<p>No hay productos</p>';
            }
        } catch (error) {
            console.error('Error al cargar categorías:', error);
            if (ui.tabs) ui.tabs.innerHTML = '<div class="tab error">Error al cargar categorías</div>';
        }

        poblarDatalist();
        return state.categorias;
    }

    function renderTabs() {
        if (!ui.tabs) return;
        ui.tabs.innerHTML = '';

        if (!state.categorias.length) {
            ui.tabs.innerHTML = '<div class="tab empty">Sin categorías</div>';
            return;
        }

        state.categorias.forEach((categoria) => {
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.tab = categoria;
            tab.textContent = categoria;
            tab.addEventListener('click', () => seleccionarTab(categoria));
            ui.tabs.appendChild(tab);
        });

        marcarTabActiva(state.categoriaActiva);
    }

    async function seleccionarTab(categoria) {
        if (!categoria) return;
        state.categoriaActiva = categoria;
        marcarTabActiva(categoria);
        try {
            const productos = await fetchWithAuth(`/api/Productos/PorCategoriaAdmin/${encodeURIComponent(categoria)}`);
            renderizarProductos(productos);
        } catch (error) {
            console.error('Error al cargar productos:', error);
            if (ui.grid) ui.grid.innerHTML = '<p>Error al cargar productos</p>';
        }
    }

    function marcarTabActiva(categoria) {
        if (!ui.tabs) return;
        ui.tabs.querySelectorAll('.tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === categoria);
        });
    }

    function renderizarProductos(productos = []) {
        if (!ui.grid) return;
        const cacheBuster = Date.now();

        if (!productos.length) {
            ui.grid.innerHTML = '<p>No hay productos</p>';
            return;
        }

        ui.grid.innerHTML = productos.map(p => {
            const nombre = escapeHtml(p.nombre ?? '');
            const descripcion = escapeHtml(p.descripcion ?? '');
            const categoria = escapeHtml(p.categoria ?? '');
            const tiempo = typeof p.tiempoPreparacion === 'number' ? p.tiempoPreparacion : '';
            const precio = typeof p.precio === 'number' ? p.precio.toFixed(2) : '0.00';
            const activo = p.activo === false ? 'Inactivo' : 'Activo';
            return `
            <div class="producto-card" data-id="${p.id}">
                <div class="producto-info">
                    <h4>${nombre}</h4>
                    <p>${descripcion}</p>
                    <p>Categoría: ${categoria}</p>
                    <p class="precio">$${precio}</p>
                    <p class="tiempo"><i class="fa-regular fa-clock"></i> ${tiempo} min</p>
                    <p class="estado">Estado: ${activo}</p>
                </div>
                <img src="/Img/${p.id}.jpg?v=${cacheBuster}" alt="${nombre}" onerror="this.src='/Img/default.jpg'">
                <div class="acciones">
                    <button class="btn-editar"
                        data-id="${p.id}"
                        data-nombre="${encodeURIComponent(p.nombre ?? '')}"
                        data-descripcion="${encodeURIComponent(p.descripcion ?? '')}"
                        data-categoria="${encodeURIComponent(p.categoria ?? '')}"
                        data-precio="${p.precio ?? ''}"
                        data-tiempo="${p.tiempoPreparacion ?? ''}"
                        data-activo="${p.activo === false ? 'false' : 'true'}">
                        Editar
                    </button>
                    <button class="eliminar btn-open-delete"
                        data-id="${p.id}"
                        data-nombre="${encodeURIComponent(p.nombre ?? '')}"
                        data-categoria="${encodeURIComponent(p.categoria ?? '')}">
                        Eliminar
                    </button>
                </div>
            </div>`;
        }).join('');

        ui.grid.querySelectorAll('.btn-editar').forEach(btn => {
            btn.addEventListener('click', () => abrirModalEditar(btn.dataset));
        });

        ui.grid.querySelectorAll('.btn-open-delete').forEach(btn => {
            btn.addEventListener('click', () => abrirModalEliminar(btn.dataset));
        });
    }

    function abrirModalEditar(dataset = {}) {
        const id = Number(dataset.id);
        if (!id) {
            alert('No se pudo identificar el producto a editar.');
            return;
        }

        state.productoEditId = id;
        const nombre = decodeURIComponent(dataset.nombre || '');
        const descripcion = decodeURIComponent(dataset.descripcion || '');
        const categoria = decodeURIComponent(dataset.categoria || '');
        const precio = dataset.precio || '';
        const tiempo = dataset.tiempo || '';
        const activo = dataset.activo === 'false' ? 'false' : 'true';

        if (ui.edit.id) ui.edit.id.value = id;
        if (ui.edit.nombre) ui.edit.nombre.value = nombre;
        if (ui.edit.descripcion) ui.edit.descripcion.value = descripcion;
        if (ui.edit.precio) ui.edit.precio.value = precio;
        if (ui.edit.tiempo) ui.edit.tiempo.value = tiempo;
        if (ui.edit.activo) ui.edit.activo.value = activo;
        if (ui.edit.preview) ui.edit.preview.src = `/Img/${id}.jpg?v=${Date.now()}`;
        if (ui.edit.nuevaCategoria) ui.edit.nuevaCategoria.value = '';
        if (ui.edit.foto) ui.edit.foto.value = '';

        state.categoriaOriginal = categoria;
        if (ui.edit.categoriaHidden) ui.edit.categoriaHidden.value = categoria;
        if (ui.edit.categoriaInput) {
            ui.edit.categoriaInput.value = '';
            ui.edit.categoriaInput.placeholder = categoria ? `Categoría actual: ${categoria}` : 'Seleccione o escriba una categoría';
        }
        if (ui.edit.categoriaActualLabel) {
            ui.edit.categoriaActualLabel.textContent = categoria ? `Actual: ${categoria}` : '';
        }

        poblarDatalist();
        mostrarModal(ui.modalEditar);
    }

    function abrirModalEliminar(dataset = {}) {
        const id = Number(dataset.id);
        if (!id) {
            alert('No se pudo identificar el producto a eliminar.');
            return;
        }

        state.productoDeleteId = id;
        const nombre = decodeURIComponent(dataset.nombre || '');
        const categoria = decodeURIComponent(dataset.categoria || '');

        if (ui.eliminar.nombre) ui.eliminar.nombre.textContent = nombre;
        if (ui.eliminar.categoria) ui.eliminar.categoria.textContent = categoria ? `Categoría: ${categoria}` : '';
        if (ui.eliminar.imagen) {
            ui.eliminar.imagen.src = `/Img/${id}.jpg?v=${Date.now()}`;
            ui.eliminar.imagen.onerror = () => { ui.eliminar.imagen.src = '/Img/default.jpg'; };
        }

        mostrarModal(ui.modalEliminar);
    }

    function poblarDatalist() {
        const datalist = document.getElementById('editCategoriasList');
        if (!datalist) return;

        datalist.innerHTML = '';
        const opciones = state.categorias.filter(Boolean).sort((a, b) => a.localeCompare(b));
        opciones.forEach(categoria => {
            const option = document.createElement('option');
            option.value = categoria;
            datalist.appendChild(option);
        });
    }

    function sincronizarCategoriaOculta(restaurar = false) {
        if (!ui.edit.categoriaHidden) return;
        const valor = ui.edit.categoriaInput?.value?.trim();

        if (valor) {
            ui.edit.categoriaHidden.value = valor;
        } else if (restaurar) {
            ui.edit.categoriaHidden.value = state.categoriaOriginal || '';
        }
    }

    function cerrarModalInterno(modal) {
        if (!modal) return;
        modal.style.display = 'none';

        if (modal === ui.modalEditar) {
            state.productoEditId = null;
            state.categoriaOriginal = '';
            if (ui.edit.categoriaHidden) ui.edit.categoriaHidden.value = '';
            if (ui.edit.categoriaInput) ui.edit.categoriaInput.value = '';
            if (ui.edit.nuevaCategoria) ui.edit.nuevaCategoria.value = '';
            if (ui.edit.foto) ui.edit.foto.value = '';
        }

        if (modal === ui.modalEliminar) {
            state.productoDeleteId = null;
        }
    }

    function mostrarModal(modal) {
        if (!modal) return;
        modal.style.display = 'flex';
    }

    async function eliminarProductoActual() {
        if (!state.productoDeleteId) {
            alert('No se ha seleccionado un producto para eliminar.');
            return;
        }

        try {
            const token = getAuthToken();
            const headers = {};
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const response = await fetch(`/api/Productos/EliminarProducto/${state.productoDeleteId}`, {
                method: 'DELETE',
                headers
            });

            const contentType = response.headers.get('content-type') || '';
            const isJson = contentType.includes('application/json');
            const result = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');

            if (response.ok) {
                const mensaje = result && typeof result === 'object' && 'message' in result
                    ? result.message
                    : (typeof result === 'string' && result.trim().length > 0 ? result : 'Producto eliminado exitosamente');
                alert(mensaje);
                cerrarModalInterno(ui.modalEliminar);
                state.productoDeleteId = null;
                await cargarCategorias(true, true);
            } else {
                let errorMsg = 'Error al eliminar producto';
                if (Array.isArray(result)) {
                    errorMsg = result.join(', ');
                } else if (result && typeof result === 'object') {
                    if (Array.isArray(result.errors)) {
                        errorMsg = result.errors.join(', ');
                    } else if ('message' in result) {
                        errorMsg = result.message;
                    }
                } else if (typeof result === 'string' && result.trim().length > 0) {
                    errorMsg = result;
                }
                alert(errorMsg);
            }
        } catch (error) {
            console.error('Error al eliminar producto:', error);
            alert(error?.message || 'Error al eliminar producto. Por favor, intente nuevamente.');
        }
    }

    window.cerrarModal = (id) => {
        if (id === 'modalEditar') cerrarModalInterno(ui.modalEditar);
        if (id === 'modalEliminar') cerrarModalInterno(ui.modalEliminar);
    };
</script>

