@{
    Layout = "_LayoutCocinero";
    ViewData["Title"] = "Panel Cocina";
}

<div class="column" id="colNuevos">
    <h3 id="tituloNuevos">üü¶ Nuevos (0)</h3>
    <div class="orders" id="listaNuevos">
        <p class="empty-state">Sin √≥rdenes nuevas.</p>
    </div>
</div>

<div class="column" id="colPreparacion">
    <h3 id="tituloPreparacion">üüß En Preparaci√≥n (0)</h3>
    <div class="orders" id="listaPreparacion">
        <p class="empty-state">Sin √≥rdenes en preparaci√≥n.</p>
    </div>
</div>

<div class="column" id="colListos">
    <h3 id="tituloListos">üü© Listos (0)</h3>
    <div class="orders" id="listaListos">
        <p class="empty-state">Sin √≥rdenes listas.</p>
    </div>
</div>

<div id="overlayDetalles" class="overlay-cocina" style="display:none;">
    <div class="modal-cocina">
        <header class="modal-header">
            <h1 id="tituloOrden">üìã Detalles de Orden</h1>
            <button class="close" onclick="cerrarModalDetalles()">‚úï</button>
        </header>

        <div class="modal-body">
            <div id="cargandoDetalle" class="loading warm-loading">Cargando detalles...</div>

            <div id="contenidoDetalle" style="display:none;">
                <div class="warm-info">
                    <div class="columna">
                        <p><strong>Mesa</strong><br><span id="numMesaDetalle"></span></p>
                        <p><strong>Mesero</strong><br><span id="nombreMeseroDetalle"></span></p>
                    </div>

                    <div class="columna">
                        <p><strong>Hora</strong><br><span id="fechaHoraDetalle"></span></p>
                        <p><strong>Estado</strong><br><span id="estadoDetalle"></span></p>
                    </div>
                </div>

                <label>Notas</label>
                <textarea id="notasDetalle" rows="3" readonly></textarea>

                <h3>Productos</h3>
                <div id="listaProductosDetalle"></div>

                <div class="total">
                    Total: <strong id="totalDetalle">$0.00</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            pedidos: {
                nuevos: [],
                preparacion: [],
                listos: []
            },
            cargaInicial: true
        };

        const ui = {
            columnas: {
                nuevos: {
                    titulo: document.getElementById('tituloNuevos'),
                    contenedor: document.getElementById('listaNuevos')
                },
                preparacion: {
                    titulo: document.getElementById('tituloPreparacion'),
                    contenedor: document.getElementById('listaPreparacion')
                },
                listos: {
                    titulo: document.getElementById('tituloListos'),
                    contenedor: document.getElementById('listaListos')
                }
            },
            modal: {
                overlay: document.getElementById('overlayDetalles'),
                cargando: document.getElementById('cargandoDetalle'),
                contenido: document.getElementById('contenidoDetalle'),
                titulo: document.getElementById('tituloOrden'),
                numMesa: document.getElementById('numMesaDetalle'),
                mesero: document.getElementById('nombreMeseroDetalle'),
                fecha: document.getElementById('fechaHoraDetalle'),
                estado: document.getElementById('estadoDetalle'),
                notas: document.getElementById('notasDetalle'),
                total: document.getElementById('totalDetalle'),
                productos: document.getElementById('listaProductosDetalle')
            }
        };

        init();

        const manejarEventosTiempoReal = () => cargarPedidos();

        window.addEventListener('pedidos:hubListo', manejarEventosTiempoReal);
        window.addEventListener('pedidos:pedidoEnviado', manejarEventosTiempoReal);
        window.addEventListener('pedidos:actualizar', manejarEventosTiempoReal);
        window.addEventListener('pedidos:estadoActualizado', manejarEventosTiempoReal);

        if (window.pedidosHubClient?.ensureStarted) {
            window.pedidosHubClient.ensureStarted();
        }

        function init() {
            const token = obtenerToken();
            const usuario = obtenerUsuario();

            if (!token || (usuario?.rol ?? '').toLowerCase() !== 'cocinero') {
                alert('Acceso no autorizado. Inicia sesi√≥n como cocinero.');
                window.location.href = '/';
                return;
            }

            cargarPedidos();
        }

        async function cargarPedidos() {
            if (state.cargaInicial) {
                mostrarEstadoCarga(true);
            }

            try {
                const [nuevos, preparacion, listos] = await Promise.all([
                    fetchPedidos('/api/Cocina/Enviados'),
                    fetchPedidos('/api/Cocina/EnPreparacion'),
                    fetchPedidos('/api/Cocina/Listo')
                ]);

                state.pedidos.nuevos = nuevos;
                state.pedidos.preparacion = preparacion;
                state.pedidos.listos = listos;

                renderColumnas();
            } catch (error) {
                console.error('Error al cargar pedidos:', error);
                alert(error?.message || 'No se pudieron cargar los pedidos.');
            } finally {
                state.cargaInicial = false;
                mostrarEstadoCarga(false);
            }
        }

        function mostrarEstadoCarga(mostrando) {
            if (!mostrando) {
                return;
            }

            Object.values(ui.columnas).forEach(({ contenedor }) => {
                contenedor.innerHTML = '<p class="empty-state">Cargando pedidos...</p>';
            });
        }

        async function fetchPedidos(url) {
            const token = obtenerToken();
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, { headers });
            const isJson = (response.headers.get('content-type') || '').includes('application/json');
            const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');

            if (!response.ok) {
                const message = Array.isArray(body)
                    ? body.join(', ')
                    : (body?.message || (typeof body === 'string' && body.trim()) || `Error ${response.status}`);
                throw new Error(message);
            }

            if (!Array.isArray(body)) {
                return [];
            }

            return body.map(normalizarPedido);
        }

        function normalizarPedido(data = {}) {
            return {
                id: data.id ?? data.Id ?? 0,
                numMesa: data.numMesa ?? data.NumMesa ?? '‚Äî',
                tomadoEn: data.tomadoEn ?? data.TomadoEn ?? null,
                precioTotal: Number(data.precioTotal ?? data.PrecioTotal ?? 0),
                estado: data.estado ?? data.Estado ?? '',
                usuario: data.usuarioNombre ?? data.UsuarioNombre ?? '‚Äî'
            };
        }

        function renderColumnas() {
            renderColumna(ui.columnas.nuevos, state.pedidos.nuevos, 'nuevos');
            renderColumna(ui.columnas.preparacion, state.pedidos.preparacion, 'preparacion');
            renderColumna(ui.columnas.listos, state.pedidos.listos, 'listos');
        }

        function renderColumna(columnaUi, pedidos, tipo) {
            if (!columnaUi) {
                return;
            }

            const { titulo, contenedor } = columnaUi;

            if (titulo) {
                const encabezado = tipo === 'nuevos'
                    ? 'üü¶ Nuevos'
                    : tipo === 'preparacion'
                        ? 'üüß En Preparaci√≥n'
                        : 'üü© Listos';
                titulo.textContent = `${encabezado} (${pedidos.length})`;
            }

            contenedor.innerHTML = '';
            if (!pedidos.length) {
                const vacio = document.createElement('p');
                vacio.className = 'empty-state';
                vacio.textContent = tipo === 'nuevos'
                    ? 'Sin √≥rdenes nuevas.'
                    : tipo === 'preparacion'
                        ? 'Sin √≥rdenes en preparaci√≥n.'
                        : 'Sin √≥rdenes listas.';
                contenedor.appendChild(vacio);
                return;
            }

            const fragment = document.createDocumentFragment();
            pedidos.forEach(pedido => {
                fragment.appendChild(crearTarjetaPedido(pedido, tipo));
            });
            contenedor.appendChild(fragment);
        }

        function crearTarjetaPedido(pedido, tipo) {
            const card = document.createElement('div');
            card.className = 'order';
            card.dataset.pedidoId = pedido.id;

            card.innerHTML = `
                <h4>Mesa ${pedido.numMesa}</h4>
                <p>Orden #${pedido.id}</p>
                <p style="color:red;">‚è∞ ${formatearHora(pedido.tomadoEn)}</p>
                <p>Tomado por: ${escapeHtml(pedido.usuario)}</p>
                <p class="price">$${pedido.precioTotal.toFixed(2)}</p>
            `;

            const botones = document.createElement('div');
            botones.className = 'order-buttons';

            const btnVer = document.createElement('button');
            btnVer.className = 'btn-ver';
            btnVer.type = 'button';
            btnVer.textContent = 'üëÅ Ver';
            btnVer.addEventListener('click', () => abrirModalDetalles(pedido.id));
            botones.appendChild(btnVer);

            if (tipo !== 'listos') {
                const btnAccion = document.createElement('button');
                btnAccion.className = 'btn-comenzar';
                btnAccion.type = 'button';
                btnAccion.textContent = tipo === 'nuevos' ? '‚úî Comenzar' : '‚úî Listo';
                btnAccion.addEventListener('click', () => actualizarEstadoPedido(pedido.id, btnAccion));
                botones.appendChild(btnAccion);
            } else {
                const btnEliminar = document.createElement('button');
                btnEliminar.className = 'btn-eliminar';
                btnEliminar.type = 'button';
                btnEliminar.textContent = 'üóë Eliminar';
                btnEliminar.disabled = true;
                btnEliminar.title = 'Pendiente de implementaci√≥n';
                botones.appendChild(btnEliminar);
            }

            card.appendChild(botones);
            return card;
        }

        async function actualizarEstadoPedido(id, boton) {
            if (!id) {
                return;
            }

            const textoOriginal = boton.textContent;
            boton.disabled = true;
            boton.textContent = 'Actualizando...';

            try {
                const token = obtenerToken();
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`/api/Cocina/ActualizarEstado/${id}`, {
                    method: 'PUT',
                    headers
                });

                const isJson = (response.headers.get('content-type') || '').includes('application/json');
                const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');

                if (!response.ok) {
                    const message = Array.isArray(body)
                        ? body.join(', ')
                        : (body?.message || (typeof body === 'string' && body.trim()) || `Error ${response.status}`);
                    throw new Error(message);
                }

                await cargarPedidos();
            } catch (error) {
                console.error('Error al actualizar estado:', error);
                alert(error?.message || 'No se pudo actualizar el estado del pedido.');
            } finally {
                boton.disabled = false;
                boton.textContent = textoOriginal;
            }
        }

        async function abrirModalDetalles(idPedido) {
            if (!idPedido || !ui.modal.overlay) {
                return;
            }

            ui.modal.overlay.style.display = 'flex';
            ui.modal.cargando.style.display = 'block';
            ui.modal.contenido.style.display = 'none';

            try {
                const data = await fetchDetallePedido(idPedido);
                renderDetallePedido(data);
            } catch (error) {
                console.error('No se pudieron cargar los detalles del pedido:', error);
                ui.modal.cargando.textContent = error?.message || 'No se pudieron cargar los detalles.';
            } finally {
                ui.modal.cargando.style.display = 'none';
                ui.modal.contenido.style.display = 'block';
            }
        }

        async function fetchDetallePedido(idPedido) {
            const token = obtenerToken();
            const headers = { 'Content-Type': 'application/json' };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(`/api/Cocina/VerDetalles/${idPedido}`, { headers });
            const isJson = (response.headers.get('content-type') || '').includes('application/json');
            const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');

            if (!response.ok) {
                const message = Array.isArray(body)
                    ? body.join(', ')
                    : (body?.message || (typeof body === 'string' && body.trim()) || `Error ${response.status}`);
                throw new Error(message);
            }

            return normalizarDetallePedido(body);
        }

        function normalizarDetallePedido(data = {}) {
            const detalles = (data.detalles ?? data.Detalles ?? []).map(detalle => ({
                nombre: detalle.nombreProducto ?? detalle.NombreProducto ?? 'Producto sin nombre',
                cantidad: Number(detalle.cantidad ?? detalle.Cantidad ?? 0),
                precioUnitario: Number(detalle.precioUnitario ?? detalle.PrecioUnitario ?? 0),
                subtotal: Number(detalle.subtotal ?? detalle.Subtotal ?? 0)
            }));

            return {
                id: data.id ?? data.Id ?? 0,
                numMesa: data.numMesa ?? data.NumMesa ?? '‚Äî',
                mesero: data.usuarioNombre ?? data.UsuarioNombre ?? '‚Äî',
                tomadoEn: data.tomadoEn ?? data.TomadoEn ?? null,
                estado: data.estado ?? data.Estado ?? '‚Äî',
                notas: data.notasEspeciales ?? data.NotasEspeciales ?? '',
                precioTotal: Number(data.precioTotal ?? data.PrecioTotal ?? 0),
                detalles
            };
        }

        function renderDetallePedido(pedido) {
            if (!pedido || !ui.modal) {
                return;
            }

            ui.modal.titulo.textContent = `Detalles de Orden #${pedido.id}`;
            ui.modal.numMesa.textContent = pedido.numMesa;
            ui.modal.mesero.textContent = pedido.mesero;
            ui.modal.fecha.textContent = pedido.tomadoEn ? formatearFechaCompleta(pedido.tomadoEn) : '‚Äî';
            ui.modal.estado.textContent = pedido.estado;
            ui.modal.notas.value = pedido.notas || 'Sin notas especiales';
            ui.modal.total.textContent = `$${pedido.precioTotal.toFixed(2)}`;

            renderProductosDetalle(pedido.detalles);
        }

        function renderProductosDetalle(detalles = []) {
            if (!ui.modal.productos) {
                return;
            }

            ui.modal.productos.innerHTML = '';
            if (!detalles.length) {
                ui.modal.productos.innerHTML = '<p class="warm-empty">Esta orden no contiene productos.</p>';
                return;
            }

            const fragment = document.createDocumentFragment();
            detalles.forEach(detalle => {
                const producto = document.createElement('div');
                producto.className = 'warm-producto';

                producto.innerHTML = `
                    <div>
                        <p class="nombre">${escapeHtml(detalle.nombre)}</p>
                        <p>Cantidad: ${detalle.cantidad}</p>
                    </div>
                    <div class="precio">
                        <p>$${detalle.subtotal.toFixed(2)}</p>
                        <small>Unitario: $${detalle.precioUnitario.toFixed(2)}</small>
                    </div>
                `;

                fragment.appendChild(producto);
            });

            ui.modal.productos.appendChild(fragment);
        }

        function cerrarModalDetalles() {
            if (ui.modal?.overlay) {
                ui.modal.overlay.style.display = 'none';
            }
        }

        window.cerrarModalDetalles = cerrarModalDetalles;

        function obtenerToken() {
            return sessionStorage.getItem('token') || localStorage.getItem('token') || '';
        }

        function obtenerUsuario() {
            const parseUsuario = (valor) => {
                if (!valor) {
                    return null;
                }
                try {
                    return JSON.parse(valor);
                } catch {
                    return null;
                }
            };

            return parseUsuario(sessionStorage.getItem('usuario')) ?? parseUsuario(localStorage.getItem('usuario'));
        }

        function formatearHora(fechaIso) {
            if (!fechaIso) {
                return '‚Äî';
            }
            const fecha = new Date(fechaIso);
            if (Number.isNaN(fecha.getTime())) {
                return '‚Äî';
            }
            return fecha.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatearFechaCompleta(valor) {
            const fecha = new Date(valor);
            if (Number.isNaN(fecha.getTime())) {
                return '‚Äî';
            }
            return fecha.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(str = '') {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
    });
</script>
