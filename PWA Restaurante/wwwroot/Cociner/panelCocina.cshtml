@{
    Layout = "_LayoutCocinero";
    ViewData["Title"] = "Panel Cocina";
}

<div class="column" id="colNuevos">
    <h3 id="tituloNuevos">üü¶ Nuevos (0)</h3>
    <div class="orders" id="listaNuevos">
        <p class="empty-state">Sin √≥rdenes nuevas.</p>
    </div>
</div>

<div class="column" id="colPreparacion">
    <h3 id="tituloPreparacion">üüß En Preparaci√≥n (0)</h3>
    <div class="orders" id="listaPreparacion">
        <p class="empty-state">Sin √≥rdenes en preparaci√≥n.</p>
    </div>
</div>

<div class="column" id="colListos">
    <h3 id="tituloListos">üü© Listos (0)</h3>
    <div class="orders" id="listaListos">
        <p class="empty-state">Sin √≥rdenes listas.</p>
    </div>
</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                pedidos: {
                    nuevos: [],
                    preparacion: [],
                    listos: []
                },
                cargaInicial: true
            };

            const ui = {
                columnas: {
                    nuevos: {
                        titulo: document.getElementById('tituloNuevos'),
                        contenedor: document.getElementById('listaNuevos')
                    },
                    preparacion: {
                        titulo: document.getElementById('tituloPreparacion'),
                        contenedor: document.getElementById('listaPreparacion')
                    },
                    listos: {
                        titulo: document.getElementById('tituloListos'),
                        contenedor: document.getElementById('listaListos')
                    }
                }
            };

            init();

            const manejarEventosTiempoReal = () => {
                cargarPedidos();
            };

            window.addEventListener('pedidos:hubListo', manejarEventosTiempoReal);
            window.addEventListener('pedidos:pedidoEnviado', manejarEventosTiempoReal);
            window.addEventListener('pedidos:actualizar', manejarEventosTiempoReal);
            window.addEventListener('pedidos:estadoActualizado', manejarEventosTiempoReal);

            if (window.pedidosHubClient?.ensureStarted) {
                window.pedidosHubClient.ensureStarted();
            }

            function init() {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                const usuario = JSON.parse(sessionStorage.getItem('usuario') || localStorage.getItem('usuario') || '{}');

                if (!token || (usuario?.rol ?? '').toLowerCase() !== 'cocinero') {
                    alert('Acceso no autorizado. Inicia sesi√≥n como cocinero.');
                    window.location.href = '/';
                    return;
                }

                cargarPedidos();
            }

            async function cargarPedidos() {
                mostrarEstadoCarga(true);
                try {
                    const [nuevos, preparacion, listos] = await Promise.all([
                        fetchPedidos('/api/Cocina/Enviados'),
                        fetchPedidos('/api/Cocina/EnPreparacion'),
                        fetchPedidos('/api/Cocina/Listo')
                    ]);

                    state.pedidos.nuevos = nuevos;
                    state.pedidos.preparacion = preparacion;
                    state.pedidos.listos = listos;

                    renderColumnas();
                } catch (error) {
                    console.error('Error al cargar pedidos:', error);
                    alert(error?.message || 'No se pudieron cargar los pedidos.');
                } finally {
                    mostrarEstadoCarga(false);
                }
            }

            function mostrarEstadoCarga(mostrando) {
                if (!mostrando) return;
                Object.values(ui.columnas).forEach(({ contenedor }) => {
                    contenedor.innerHTML = '<p class="empty-state">Cargando pedidos...</p>';
                });
            }

            async function fetchPedidos(url) {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = `Bearer ${token}`;

                const response = await fetch(url, { headers });
                const isJson = (response.headers.get('content-type') || '').includes('application/json');
                const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');

                if (!response.ok) {
                    const message = Array.isArray(body)
                        ? body.join(', ')
                        : (body?.message || (typeof body === 'string' && body.trim()) || `Error ${response.status}`);
                    throw new Error(message);
                }

                if (!Array.isArray(body)) return [];
                return body.map(normalizarPedido);
            }

            function normalizarPedido(data = {}) {
                return {
                    id: data.id ?? data.Id ?? 0,
                    numMesa: data.numMesa ?? data.NumMesa ?? '‚Äî',
                    tomadoEn: data.tomadoEn ?? data.TomadoEn ?? null,
                    precioTotal: Number(data.precioTotal ?? data.PrecioTotal ?? 0),
                    estado: data.estado ?? data.Estado ?? '',
                    usuario: data.usuarioNombre ?? data.UsuarioNombre ?? '‚Äî'
                };
            }

            function renderColumnas() {
                renderColumna(ui.columnas.nuevos, state.pedidos.nuevos, 'nuevos');
                renderColumna(ui.columnas.preparacion, state.pedidos.preparacion, 'preparacion');
                renderColumna(ui.columnas.listos, state.pedidos.listos, 'listos');
            }

            function renderColumna(columnaUi, pedidos, tipo) {
                if (!columnaUi) return;
                const { titulo, contenedor } = columnaUi;

                if (titulo) {
                    const encabezado = tipo === 'nuevos'
                        ? 'üü¶ Nuevos'
                        : tipo === 'preparacion'
                            ? 'üüß En Preparaci√≥n'
                            : 'üü© Listos';
                    titulo.textContent = `${encabezado} (${pedidos.length})`;
                }

                contenedor.innerHTML = '';
                if (!pedidos.length) {
                    const vacio = document.createElement('p');
                    vacio.className = 'empty-state';
                    vacio.textContent = tipo === 'nuevos'
                        ? 'Sin √≥rdenes nuevas.'
                        : tipo === 'preparacion'
                            ? 'Sin √≥rdenes en preparaci√≥n.'
                            : 'Sin √≥rdenes listas.';
                    contenedor.appendChild(vacio);
                    return;
                }

                const fragment = document.createDocumentFragment();
                pedidos.forEach(pedido => {
                    fragment.appendChild(crearTarjetaPedido(pedido, tipo));
                });
                contenedor.appendChild(fragment);
            }

            function crearTarjetaPedido(pedido, tipo) {
                const card = document.createElement('div');
                card.className = 'order';
                card.dataset.pedidoId = pedido.id;

                card.innerHTML = `
                    <h4>Mesa ${pedido.numMesa}</h4>
                    <p>Orden #${pedido.id}</p>
                    <p style="color:red;">‚è∞ ${formatearHora(pedido.tomadoEn)}</p>
                    <p>Tomado por: ${escapeHtml(pedido.usuario)}</p>
                    <p class="price">$${pedido.precioTotal.toFixed(2)}</p>
                `;

                const botones = document.createElement('div');
                botones.className = 'order-buttons';

                const btnVer = document.createElement('button');
                btnVer.className = 'btn-ver';
                btnVer.type = 'button';
                btnVer.textContent = 'üëÅ Ver';
                btnVer.onclick = null;
                botones.appendChild(btnVer);

                if (tipo !== 'listos') {
                    const btnAccion = document.createElement('button');
                    btnAccion.className = 'btn-comenzar';
                    btnAccion.type = 'button';
                    btnAccion.textContent = tipo === 'nuevos' ? '‚úî Comenzar' : '‚úî Listo';
                    btnAccion.addEventListener('click', () => actualizarEstadoPedido(pedido.id, btnAccion));
                    botones.appendChild(btnAccion);
                }

                card.appendChild(botones);
                return card;
            }

            async function actualizarEstadoPedido(id, boton) {
                if (!id) return;
                const textoOriginal = boton.textContent;
                boton.disabled = true;
                boton.textContent = 'Actualizando...';

                try {
                    const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                    const headers = { 'Content-Type': 'application/json' };
                    if (token) headers['Authorization'] = `Bearer ${token}`;

                    const response = await fetch(`/api/Cocina/ActualizarEstado/${id}`, {
                        method: 'PUT',
                        headers
                    });

                    const isJson = (response.headers.get('content-type') || '').includes('application/json');
                    const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => '');

                    if (!response.ok) {
                        const message = Array.isArray(body)
                            ? body.join(', ')
                            : (body?.message || (typeof body === 'string' && body.trim()) || `Error ${response.status}`);
                        throw new Error(message);
                    }

                    await cargarPedidos();
                } catch (error) {
                    console.error('Error al actualizar estado:', error);
                    alert(error?.message || 'No se pudo actualizar el estado del pedido.');
                } finally {
                    boton.disabled = false;
                    boton.textContent = textoOriginal;
                }
            }

            function formatearHora(fechaIso) {
                if (!fechaIso) return '‚Äî';
                const fecha = new Date(fechaIso);
                if (Number.isNaN(fecha.getTime())) return '‚Äî';
                return fecha.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function escapeHtml(str = '') {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
        });
    </script>

