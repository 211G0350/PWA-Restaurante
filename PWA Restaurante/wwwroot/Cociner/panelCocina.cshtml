@{
    Layout = "_LayoutCocinero";
    ViewData["Title"] = "Panel Cocina";
}

<div class="column" id="colNuevos">
    <h3 id="tituloNuevos">üü¶ Nuevos (0)</h3>
    <div class="orders" id="listaNuevos">
        <p class="empty-state">Sin √≥rdenes nuevas.</p>
    </div>
</div>

<div class="column" id="colPreparacion">
    <h3 id="tituloPreparacion">üüß En Preparaci√≥n (0)</h3>
    <div class="orders" id="listaPreparacion">
        <p class="empty-state">Sin √≥rdenes en preparaci√≥n.</p>
    </div>
</div>

<div class="column" id="colListos">
    <h3 id="tituloListos">üü© Listos (0)</h3>
    <div class="orders" id="listaListos">
        <p class="empty-state">Sin √≥rdenes listas.</p>
    </div>
</div>

<!-- ‚úÖ MODAL DETALLES -->
<div id="overlayDetalles" class="overlay-cocina" style="display:none;">
    <div class="modal-cocina">
        <header class="modal-header">
            <h1 id="tituloOrden">üìã Detalles de Orden</h1>
            <button class="close" onclick="cerrarModalDetalles()">‚úï</button>
        </header>

        <div class="modal-body">
            <div id="cargandoDetalle" class="loading warm-loading">Cargando detalles...</div>

            <div id="contenidoDetalle" style="display:none;">
                <div class="warm-info">
                    <div class="columna">
                        <p><strong>Mesa</strong><br><span id="numMesaDetalle"></span></p>
                        <p><strong>Mesero</strong><br><span id="nombreMeseroDetalle"></span></p>
                    </div>

                    <div class="columna">
                        <p><strong>Hora</strong><br><span id="fechaHoraDetalle"></span></p>
                        <p><strong>Estado</strong><br><span id="estadoDetalle"></span></p>
                    </div>
                </div>

                <label>Notas</label>
                <textarea id="notasDetalle" rows="3" readonly></textarea>

                <h3>Productos</h3>
                <div id="listaProductosDetalle"></div>

                <div class="total">
                    Total: <strong id="totalDetalle">$0.00</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    /* ====================================================================
       INICIALIZACI√ìN
    ====================================================================*/

    document.addEventListener('DOMContentLoaded', () => {

        const state = {
            pedidos: { nuevos: [], preparacion: [], listos: [] }
        };

        const ui = {
            columnas: {
                nuevos: { titulo: document.getElementById("tituloNuevos"), contenedor: document.getElementById("listaNuevos") },
                preparacion: { titulo: document.getElementById("tituloPreparacion"), contenedor: document.getElementById("listaPreparacion") },
                listos: { titulo: document.getElementById("tituloListos"), contenedor: document.getElementById("listaListos") }
            }
        };

        init();

        function init() {
            cargarPedidos();
        }

        /* ====================================================================
           CARGA DE PEDIDOS
        ====================================================================*/

        async function cargarPedidos() {
            try {
                const [nuevos, preparacion, listos] = await Promise.all([
                    fetchPedidos('/api/Cocina/Enviados'),
                    fetchPedidos('/api/Cocina/EnPreparacion'),
                    fetchPedidos('/api/Cocina/Listo')
                ]);

                state.pedidos.nuevos = nuevos;
                state.pedidos.preparacion = preparacion;
                state.pedidos.listos = listos;

                renderColumnas();
            }
            catch (e) { console.error(e); }
        }

        async function fetchPedidos(url) {
            const token = localStorage.getItem("token") || sessionStorage.getItem("token");

            const response = await fetch(url, {
                headers: token ? { "Authorization": "Bearer " + token } : {}
            });

            const data = await response.json();
            return data.map(p => ({
                id: p.id,
                numMesa: p.numMesa,
                tomadoEn: p.tomadoEn,
                precioTotal: p.precioTotal,
                estado: p.estado,
                usuario: p.usuarioNombre
            }));
        }

        /* ====================================================================
           RENDER DE COLUMNAS
        ====================================================================*/

        function renderColumnas() {
            renderColumna(ui.columnas.nuevos, state.pedidos.nuevos, "nuevos");
            renderColumna(ui.columnas.preparacion, state.pedidos.preparacion, "preparacion");
            renderColumna(ui.columnas.listos, state.pedidos.listos, "listos");
        }

        function renderColumna(col, pedidos, tipo) {

            col.titulo.textContent =
                (tipo === "nuevos" ? "üü¶ Nuevos" :
                 tipo === "preparacion" ? "üüß En Preparaci√≥n" :
                                           "üü© Listos") +
                ` (${pedidos.length})`;

            col.contenedor.innerHTML = "";

            pedidos.forEach(p => col.contenedor.appendChild(crearTarjetaPedido(p, tipo)));
        }

        /* ====================================================================
           TARJETA DE PEDIDO (INCLUYE BOTONES ‚úî VERDE Y üóë ROJO)
        ====================================================================*/

        function crearTarjetaPedido(pedido, tipo) {

            const card = document.createElement("div");
            card.className = "order";

            card.innerHTML = `
                <h4>Mesa ${pedido.numMesa}</h4>
                <p>Orden #${pedido.id}</p>
                <p style="color:red">‚è∞ ${formatearHora(pedido.tomadoEn)}</p>
                <p>Tomado por: ${pedido.usuario}</p>
                <p class="price">$${pedido.precioTotal.toFixed(2)}</p>
            `;

            const botones = document.createElement("div");
            botones.className = "order-buttons";

            /* ‚úÖ BOT√ìN VER */
            const btnVer = document.createElement("button");
            btnVer.className = "btn-ver";
            btnVer.textContent = "üëÅ Ver";
            btnVer.onclick = () => abrirModalDetalles(pedido.id);
            botones.appendChild(btnVer);

            /* ‚úÖ BOT√ìN VERDE (COMENZAR / LISTO) */
            if (tipo !== "listos") {
                const btnListo = document.createElement("button");
                btnListo.className = "btn-comenzar";
                btnListo.textContent = tipo === "nuevos" ? "‚úî Comenzar" : "‚úî Listo";
                btnListo.onclick = () => actualizarEstadoPedido(pedido.id, btnListo);
                botones.appendChild(btnListo);
            }

            /* ‚úÖ BOT√ìN ROJO ELIMINAR SOLO EN LISTOS */
            if (tipo === "listos") {
                const btnEliminar = document.createElement("button");
                btnEliminar.className = "btn-eliminar";
                btnEliminar.textContent = "üóë Eliminar";
                btnEliminar.onclick = async () => {
                    if (confirm("¬øEliminar esta orden?")) {
                        await eliminarPedido(pedido.id);
                    }
                };
                botones.appendChild(btnEliminar);
            }

            card.appendChild(botones);
            return card;
        }

        /* ====================================================================
           ELIMINAR PEDIDO
        ====================================================================*/

        async function eliminarPedido(id) {
            const token = localStorage.getItem("token") || sessionStorage.getItem("token");

            await fetch(`/api/Cocina/Eliminar/${id}`, {
                method: "DELETE",
                headers: token ? { "Authorization": "Bearer " + token } : {}
            });

            cargarPedidos();
        }

        /* ====================================================================
           ACTUALIZAR ESTADO (COMENZAR / LISTO)
        ====================================================================*/

        async function actualizarEstadoPedido(id, btn) {

            btn.disabled = true;
            btn.textContent = "Actualizando‚Ä¶";

            const token = localStorage.getItem("token") || sessionStorage.getItem("token");

            await fetch(`/api/Cocina/ActualizarEstado/${id}`, {
                method: "PUT",
                headers: token ? { "Authorization": "Bearer " + token } : {}
            });

            cargarPedidos();
        }

        /* ====================================================================
           MODAL DETALLES
        ====================================================================*/

        async function abrirModalDetalles(id) {

            overlayDetalles.style.display = "flex";
            cargandoDetalle.style.display = "block";
            contenidoDetalle.style.display = "none";

            const token = localStorage.getItem("token") || sessionStorage.getItem("token");

            const response = await fetch(`/api/Pedidos/VerDetalles/${id}`, {
                headers: token ? { "Authorization": "Bearer " + token } : {}
            });

            const data = await response.json();

            document.getElementById("tituloOrden").textContent = `Detalles de Orden #${data.id}`;
            document.getElementById("numMesaDetalle").textContent = data.numMesa;
            document.getElementById("nombreMeseroDetalle").textContent = data.usuarioNombre;
            document.getElementById("fechaHoraDetalle").textContent = new Date(data.tomadoEn).toLocaleString();
            document.getElementById("estadoDetalle").textContent = data.estado;
            document.getElementById("notasDetalle").value = data.notasEspeciales || "Sin notas";

            listaProductosDetalle.innerHTML = "";
            data.detalles.forEach(d => {
                listaProductosDetalle.innerHTML += `
                    <div class="warm-producto">
                        <div>
                            <p class="nombre">${d.nombreProducto}</p>
                            <p>Cantidad: ${d.cantidad}</p>
                        </div>
                        <div class="precio">
                            <p>$${d.subtotal.toFixed(2)}</p>
                            <small>Unitario: $${d.precioUnitario.toFixed(2)}</small>
                        </div>
                    </div>
                `;
            });

            totalDetalle.textContent = "$" + data.precioTotal.toFixed(2);

            cargandoDetalle.style.display = "none";
            contenidoDetalle.style.display = "block";
        }

        function cerrarModalDetalles() {
            overlayDetalles.style.display = "none";
        }

        function formatearHora(f) {
            return new Date(f).toLocaleTimeString("es-MX", { hour: "2-digit", minute: "2-digit" });
        }

    });

</script>
