<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Panel Mesero</title>

    <link rel="stylesheet" href="~/css/mes.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>
    <header class="top-bar">
        <div class="header-left">
            <img src="~/img/usuarios.png" alt="Usuario" class="user-logo" />
            <div>
                <h2>Panel Mesero</h2>
                <p>Bienvenido, <span id="nombreUsuario">Mesero</span></p>
            </div>
        </div>
        <div class="header-right">
            <button class="icon-btn" onclick="sincronizar()">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button class="icon-btn" onclick="cerrarSesion()">
                <i class="fa-solid fa-right-from-bracket"></i> Salir
            </button>
        </div>
    </header>

	<script>
		(function asegurarSesionMesero() {
			try {
				const tokenSesion = sessionStorage.getItem("token");
				const tokenLocal = localStorage.getItem("token");
				if (!tokenSesion && tokenLocal) {
					sessionStorage.setItem("token", tokenLocal);
				}

				const usuarioSesion = sessionStorage.getItem("usuario");
				const usuarioLocal = localStorage.getItem("usuario");
				if (!usuarioSesion && usuarioLocal) {
					sessionStorage.setItem("usuario", usuarioLocal);
				}
			} catch (error) {
				console.warn("No se pudo sincronizar el almacenamiento de sesión:", error);
			}
		})();
	</script>

	<main class="content">
		@RenderBody()
	</main>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	<script>
		const obtenerToken = () => sessionStorage.getItem("token") || localStorage.getItem("token") || "";
		const obtenerUsuario = () => {
			const parseUsuario = (valor) => {
				if (!valor) return null;
				try {
					return JSON.parse(valor);
				} catch {
					return null;
				}
			};

			const usuarioSesion = parseUsuario(sessionStorage.getItem("usuario"));
			if (usuarioSesion) {
				return usuarioSesion;
			}

			return parseUsuario(localStorage.getItem("usuario"));
		};

		function cerrarSesion() {
			localStorage.clear();
			sessionStorage.clear();
			window.location.href = "/";
		}

		async function sincronizar() {
			try {
				await enviarPedidosPendientes();
			} catch (error) {
				console.error("Error al enviar pedidos pendientes:", error);
				if (error?.message) {
					alert(error.message);
				}
			} finally {
				location.reload();
			}
		}

		async function enviarPedidosPendientes() {
			const token = obtenerToken();
			if (!token) {
				throw new Error("No se encontró el token de autenticación.");
			}

			const headers = { "Content-Type": "application/json" };
			if (token) {
				headers["Authorization"] = `Bearer ${token}`;
			}

			const response = await fetch("/api/Pedidos/EnviarPedidos", {
				method: "PUT",
				headers
			});

			const contentType = response.headers.get("content-type") || "";
			const isJson = contentType.includes("application/json");
			const body = isJson ? await response.json().catch(() => null) : await response.text().catch(() => "");

			if (!response.ok) {
				const message = body?.message || (typeof body === "string" && body.trim()) || `Error ${response.status}`;
				throw new Error(message);
			}

			return body;
		}

		function mostrarNombreUsuario() {
			const usuario = obtenerUsuario();
			if (usuario?.nombre) {
				document.getElementById("nombreUsuario").textContent = usuario.nombre;
			}
		}

		(function inicializarHub() {
			if (!window.signalR) {
				return;
			}

			const connection = new signalR.HubConnectionBuilder()
				.withUrl("/pedidosHub", {
					accessTokenFactory: () => obtenerToken()
				})
				.withAutomaticReconnect()
				.build();

			const iniciarConexion = async () => {
				if (connection.state === signalR.HubConnectionState.Connected || connection.state === signalR.HubConnectionState.Connecting) {
					return;
				}

				try {
					await connection.start();
					await connection.invoke("JoinMeserosGroup");
					window.dispatchEvent(new Event("pedidos:hubListo"));
				} catch (error) {
					console.error("No se pudo conectar con PedidosHub:", error);
					setTimeout(iniciarConexion, 3000);
				}
			};

			window.pedidosHubClient = {
				connection,
				ensureStarted: iniciarConexion
			};

			connection.on("ActualizarPedidos", () => window.dispatchEvent(new CustomEvent("pedidos:actualizar")));
			connection.on("EstadoActualizado", data => window.dispatchEvent(new CustomEvent("pedidos:estadoActualizado", { detail: data })));
			connection.on("PedidoEnviado", data => window.dispatchEvent(new CustomEvent("pedidos:pedidoEnviado", { detail: data })));

			connection.onreconnected(() => window.dispatchEvent(new Event("pedidos:hubListo")));

			document.addEventListener("DOMContentLoaded", () => {
				if (obtenerToken()) {
					iniciarConexion();
				}
			});
		})();

		document.addEventListener("DOMContentLoaded", mostrarNombreUsuario);
	</script>
</body>
</html>
